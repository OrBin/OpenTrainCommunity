{"version":3,"sources":["RouteExplorer.js","polyfills.js","controllers/AppController.js","controllers/GraphsController.js","app.js","controllers/HeatMapController.js","controllers/HighlightsController.js","controllers/RouteDetailsController.js","controllers/RoutesController.js","controllers/SelectRoutesController.js","controllers/SelectStopsController.js","controllers/TimesDetailsController.js","controllers/TopHighlightsController.js","controllers/TripDetails.js","directives/PercentBar.js","directives/TimesDetails.js","filters/display.js","filters/duration.js","services/Layout.js","services/Locale.js","services/LocationBinder.js","services/TimeParser.js"],"names":["app","angular","module","constant","baseDir","config","$routeProvider","env","templateUrl","templateName","when","pageId","controller","resolve","Layout","reloadOnSearch","otherwise","redirectTo","String","prototype","repeat","count","this","TypeError","str","RangeError","Infinity","Math","floor","length","rpt","$scope","$location","share","prefix","url","encodeURIComponent","window","open","$on","e","route","bodyClass","value","name","values","$http","$q","$timeout","daysTable","hoursList","monthNames","wip","input","graphKind","updateSkipped","refresh","skippedCall","isMustSkipChecked","fromToStops","some","st","mustSkip","actualFromToStops","_this","filter","mustSkipComplementMode","skippedToggleAll","hasSelected","forEach","idx","getSkipped","map","id","join","startStop","endStop","startDate","endDate","search","stops","getStops","stopsById","cbs","get","params","from_date","to_date","from_stop","to_stop","skipped","undefined","skipped_complement","then","resp","stat","data","table","push","fromToStopsIds","stopId","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","err","all","updateChart","getRouteTitle","from","to","initData","buildDates","s","first_date","month","year","last_date","buildDatesRange","startDates","endDates","ns","alert","computePerDaySeries","perDay","key","stop_id","week_day_local","num_trips","arrival_late_count","result","d","entry","y","numTrips","lineName","states","hover","lineWidth","computePerHoursSeries","perHour","hoursMapping","h","hour_key","hour_local","hl","stopNames","perDaySeries","perHoursSeries","tooltip","formatter","prec","round","x","point","useHTML","scope","chartPerDay","plotOptions","series","line","options","chart","type","title","text","xAxis","reversed","categories","yAxis","opposite","chartPerHour","findDate","dates","i","findStop","ta","console","log","extend","defaults","scrollWheelZoom","center","lat","latlon","lng","zoom","stop","paths","heatmapData","score","latlng","g","color","message","fillColor","fillOpacity","stroke","radius","latlngs","popupOptions","className","init","highlights","fields","sortKey","v","initialDesc","week_day","hours","active","asc","mean_arrival_late_pct","disableSort","sortBy","activeField","f","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","sort","v1","v2","k1","k2","$route","LocationBinder","Locale","TimeParser","getStats","dayId","timeId","statsMap","selectedStats","stats","selectedDay","selectedTime","loadStats","times","timesMap","statGroup","info","time","formatHour","hour","slice","formatMonth","date","months","getMonth","getFullYear","offsetMonth","offset","Date","setMonth","offsetPeriod","period","size","end","routeParams","current","parsePeriod","createRequestString","routeId","stopIds","findRoute","loaded","origin","destination","selectedPeriod","days","selectRouteUrl","previousPeriod","nextPeriod","bounds","getRoutesDateRange","day","previousPeriodUrl","min","getTime","formatPeriod","nextPeriodUrl","max","route_id","success","bind","val","Number","stopStats","stopName","isDayEmpty","dayTimes","isTimeEmpty","timeStats","tripCount","selectedYear","selectedMonth","getMonths","getYears","lastYear","years","realRoutes","m","rr","firstStop","lastStop","graphsUrlParams","graphsUrl","findRoutesByPeriod","routes","isOrigin","isDestination","stopText","barWidth","percentWidth","routeUrl","$rootScope","generatePeriods","fromDate","toDate","periods","start","getDate","toName","until","reverse","dateRange","startPeriod","endPeriod","formValid","goToRoutes","noRoutes","loading","periodStr","path","dismissError","layout","parseInt","highlightLists","kind","items","late","ontime","isLegalTripId","n","tripId","isNaN","x_fields","refreshTrip","trip_id","getError","trip","directive","restrict","0","1","2","3","4","5","6","fix","h1","h0","seconds","negative","trunc","minutes","res","factory","stopsMap","routesMap","loadedPromise","response","heb_stop_names","names","r","stop_ids","minDate","min_date","maxDate","max_date","reduce","findStopName","findRoutes","originId","destinationId","matchingRoutes","originIndex","indexOf","destinationIndex","routeStops","Object","keys","r1","r2","defer","routesInDate","reject","msg","promise","service","getRoutes","abbr","scopeProperty","locationProperty","parser","$watch","sep","dd","toString","mm","yyyy","parseMonth","monthString","substr","periodString","parts","split"],"mappings":"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","file":"app.js","sourcesContent":["(function () {\n    var app = angular.module('RouteExplorer', ['ngRoute',\n        'ui.bootstrap',\n        'ui.bootstrap.buttons',\n        'leaflet-directive',\n        \"highcharts-ng\"\n    ]);\n\n    app.constant('env', {\n        baseDir: '/static/ui/RouteExplorer'\n    });\n\n    app.config(['$routeProvider','env',\n        function ($routeProvider, env) {\n\n            var templateUrl = function (templateName) {\n                return env.baseDir + '/tpls/' + templateName + '.html';\n            };\n\n            $routeProvider\n                .when('/', {\n                    pageId: 'welcome',\n                    templateUrl: templateUrl('SelectStops'),\n                    controller: 'SelectStopsController',\n                    resolve: {'Layout': 'Layout'}\n                })\n                .when('/about', {\n                    pageId: 'about',\n                    templateUrl: templateUrl('About')\n                })\n                .when('/:period/select-route/:origin/:destination', {\n                    pageId: 'routes',\n                    templateUrl: templateUrl('SelectRoute'),\n                    controller: 'SelectRouteController',\n                    resolve: {'Layout': 'Layout'},\n                    reloadOnSearch: false\n                })\n                .when('/:period/routes/:routeId', {\n                    pageId: 'route',\n                    templateUrl: templateUrl('RouteDetails'),\n                    controller: 'RouteDetailsController',\n                    resolve: {'Layout': 'Layout'},\n                    reloadOnSearch: false\n                }).when(\"/heat-map\", {\n                    pageId: 'heatMap',\n                    templateUrl: templateUrl('HeatMap'),\n                    controller: 'HeatMapController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                }).when(\"/graphs\", {\n                    pageId: 'graphs',\n                    templateUrl: templateUrl('Graphs'),\n                    controller: 'GraphsController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                })\n                .when(\"/routes\", {\n                    pageId: 'routes',\n                    templateUrl: templateUrl('RealRoutes'),\n                    controller: 'RealRoutesController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                })\n                .when(\"/highlights\", {\n                    pageId: 'highlights',\n                    templateUrl: templateUrl('Highlights'),\n                    controller: 'HighlightsController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                })\n                .when(\"/top-highlights\", {\n                    pageId: 'top_highlights',\n                    templateUrl: templateUrl('TopHighlights'),\n                    controller: 'TopHighlightsController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                })\n                .when(\"/trip-details\", {\n                    pageId: 'trip_details',\n                    templateUrl: templateUrl('TripDetails'),\n                    controller: 'TripDetailsController',\n                    reloadOnSearch: false,\n                    resolve: {'Layout': 'Layout'},\n                })\n                .otherwise({\n                    redirectTo: '/'\n                });\n        }]);\n})();\n","// String.repeat polyfill\n// taken from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/repeat#Polyfill\nif (!String.prototype.repeat) {\n  String.prototype.repeat = function(count) {\n    'use strict';\n    if (this === null) {\n      throw new TypeError('can\\'t convert ' + this + ' to object');\n    }\n    var str = '' + this;\n    count = +count;\n    if (count != count) {\n      count = 0;\n    }\n    if (count < 0) {\n      throw new RangeError('repeat count must be non-negative');\n    }\n    if (count == Infinity) {\n      throw new RangeError('repeat count must be less than infinity');\n    }\n    count = Math.floor(count);\n    if (str.length === 0 || count === 0) {\n      return '';\n    }\n    // Ensuring count is a 31-bit integer allows us to heavily optimize the\n    // main part. But anyway, most current (August 2014) browsers can't handle\n    // strings 1 << 28 chars or longer, so:\n    if (str.length * count >= 1 << 28) {\n      throw new RangeError('repeat count must not overflow maximum string size');\n    }\n    var rpt = '';\n    for (;;) {\n      if ((count & 1) == 1) {\n        rpt += str;\n      }\n      count >>>= 1;\n      if (count === 0) {\n        break;\n      }\n      str += str;\n    }\n    return rpt;\n  };\n}\n","angular.module('RouteExplorer').controller('AppController',\nfunction($scope, $location) {\n    'ngInject';\n    $scope.share = function(prefix) {\n        let url = prefix + encodeURIComponent('http://otrain.org/#' + $location.url());\n        window.open(url, 'sharePopup', 'width=600,height=550,top=100,left=100,location=no,scrollbar=no,status=no,menubar=no');\n    };\n\n    $scope.$on('$routeChangeSuccess', function(e, route) {\n        $scope.bodyClass = route.pageId ? 'rex-page-' + route.pageId : null;\n    });\n});\n","'use strict';\nangular.module('RouteExplorer').constant('daysTable',\n    [{\n        value: 0,\n        name: 'ראשון',\n    }, {\n        value: 1,\n        name: 'שני',\n    }, {\n        value: 2,\n        name: 'שלישי',\n    }, {\n        value: 3,\n        name: 'רביעי',\n    }, {\n        value: 4,\n        name: 'חמישי',\n    }, {\n        value: 5,\n        name: 'שישי',\n    }, {\n        value: 6,\n        name: 'שבת',\n    }])\n    //}], {\n    //    value: 'all',\n    //    name: 'שבועי'\n    //}\n    //])\n    .constant(\"monthNames\", [\n        'dummy',\n        'ינואר',\n        'פברואר',\n        'מרץ',\n        'אפריל',\n        'מאי',\n        'יוני',\n        'יולי',\n        'אוגוסט',\n        'ספטמבר',\n        'אוקטובר',\n        'נובמבר',\n        'דצמבר'\n    ]).constant(\"hoursList\", [\n    {\n        name: '4-7',\n        values: [4, 5, 6]\n    },\n    {\n        name: '7-9',\n        values: [7, 8]\n    },\n    {\n        name: '9-12',\n        values: [9,10,11],\n    },\n    {\n        name: '12-15',\n        values: [12,13,14],\n    },\n    {\n        name: '15-18',\n        values: [15,16,17],\n    },\n    {\n        name: '18-21',\n        values: [18, 19,20],\n    },\n    {\n        name: '21-24',\n        values: [21, 22,23],\n    },\n    {\n        name: '24-4',\n        values: [0, 1, 2, 3],\n    }\n]\n);\n\n\nangular.module('RouteExplorer').controller('GraphsController',\n        function ($scope,\n                  $http,\n                  $q,\n                  $timeout,\n                  $location,\n                  Layout,\n                  daysTable,\n                  hoursList,\n                  monthNames) {\n            'ngInject';\n            $scope.wip = true;\n            $scope.Layout = Layout;\n            $scope.input = {\n                graphKind: 'perDay'\n            };\n            $scope.updateSkipped = function() {\n                $scope.refresh(\n                    {'skippedCall': true}\n                );\n            };\n\n            $scope.isMustSkipChecked = function() {\n                if (!$scope.fromToStops) {\n                    return false;\n                }\n                return $scope.fromToStops.some(st=>st.mustSkip);\n            }\n\n            $scope.actualFromToStops = function() {\n                return $scope.fromToStops.filter(st => this.mustSkipComplementMode || !st.mustSkip);\n            };\n\n            $scope.skippedToggleAll = function() {\n                var hasSelected = $scope.fromToStops.some(st=>st.mustSkip);\n                $scope.fromToStops.forEach((st, idx) => {\n                    if (idx > 0 && idx < $scope.fromToStops.length-1) {\n                        st.mustSkip = !hasSelected;\n                    }\n                });\n            }\n\n            $scope.getSkipped = function() {\n                if (!$scope.fromToStops) {\n                    return undefined;\n                }\n                return $scope.fromToStops.filter(st=>st.mustSkip).map(st=>st.id).join(\",\");\n            };\n\n            $scope.refresh = function (config) {\n                config = config || {};\n                $scope.wip = true;\n                $scope.startStop = $scope.input.startStop;\n                $scope.endStop = $scope.input.endStop;\n                $scope.startDate = $scope.input.startDate.value;\n                $scope.endDate = $scope.input.endDate.value;\n                $location.search({\n                    startStop: $scope.startStop.id,\n                    endStop: $scope.endStop.id,\n                    startDate: $scope.startDate,\n                    endDate: $scope.endDate,\n                });\n                $scope.stops = Layout.getStops();\n                $scope.stopsById = {};\n                $scope.stops.forEach(function (st) {\n                    $scope.stopsById[st.id] = st;\n                });\n                var cbs = [\n                    $http.get('/api/v1/stats/from-to-full/', {\n                        params: {\n                            from_date: $scope.startDate,\n                            to_date: $scope.endDate,\n                            from_stop: $scope.startStop.id,\n                            to_stop: $scope.endStop.id,\n                            skipped: config.skippedCall ? $scope.getSkipped() : undefined,\n                            skipped_complement: $scope.mustSkipComplementMode ? '1' : '0',\n                        }\n                    }).then(function (resp) {\n                        $scope.stat = resp.data.table;\n                    })\n                    ];\n                if (!config.skippedCall) {\n                    cbs.push(\n                        $http.get('/api/v1/stops/from-to/', {\n                            params: {\n                                from_stop: $scope.startStop.id,\n                                to_stop: $scope.endStop.id,\n                            }\n                        }).then(function (resp) {\n                            $scope.fromToStopsIds = resp.data;\n                            $scope.fromToStops = $scope.fromToStopsIds.map(stopId => $scope.stopsById[stopId]);\n                            for (let st of $scope.fromToStops) {\n                                st.mustSkip = false;\n                            }\n                        })\n                    );\n                }\n                $q.all(cbs).then(function () {\n                    $scope.wip = false;\n                    $scope.updateChart();\n                });\n            };\n            $scope.getRouteTitle = function (route) {\n                return 'מ' + route.from + ' ל' + route.to + ' (' + route.count + ' ' + 'נסיעות' + ')';\n            }\n\n            $scope.initData = function () {\n                return $scope.buildDates();\n            };\n\n            $scope.buildDates = function () {\n                return $http.get('/api/v1/general/dates-range').then( (resp) => {\n                    let data = resp.data;\n                    var s = [data.first_date.month, data.first_date.year];\n                    var e = [data.last_date.month, data.last_date.year];\n                    $scope.buildDatesRange(s,e);\n                });\n            };\n            $scope.buildDatesRange = function(s,e) {\n                $scope.startDates = [];\n                $scope.endDates = [];\n                while (true) {\n                    let abort = false;\n                    $scope.startDates.push({\n                        name: monthNames[s[0]] + ' ' + s[1],\n                        value: '1-' + s[0] + '-' + s[1],\n                    });\n                    var ns = s[0] == 12 ? [1, s[1] + 1] : [s[0] + 1, s[1]];\n                    $scope.endDates.push({\n                        name: monthNames[s[0]] + ' ' + s[1],\n                        value: '1-' + ns[0] + '-' + ns[1],\n                    });\n                    if ($scope.startDates.length > 100) {\n                        alert(\"error\");\n                        return;\n                    }\n                    if (s[0] == e[0] && s[1] == e[1]) {\n                        return;\n                    }\n                    s = [ns[0], ns[1]];\n                }\n            };\n            $scope.computePerDaySeries = function () {\n                var perDay = {};\n                $scope.stat.forEach(function (st) {\n                    var key = st.stop_id + '-' + st.week_day_local;\n                    perDay[key] = perDay[key] || {\n                            num_trips: 0,\n                            arrival_late_count: 0\n                        };\n                    perDay[key].num_trips += st.num_trips;\n                    perDay[key].arrival_late_count += st.arrival_late_count;\n\n                });\n                var result = [];\n                daysTable.forEach(function (d) {\n                    var data = $scope.actualFromToStops().map(function (st) {\n                        var entry = perDay[st.id + '-' + d.value];\n                        var result = {};\n                        if (!entry) {\n                            result.y = 0;\n                            result.numTrips = 0;\n                            //console.log('no entry for ' + st.id + ' ' + d.value);\n                        } else {\n                            result.y = entry.arrival_late_count * 100.0 / entry.num_trips;\n                            result.numTrips = entry.num_trips;\n                        }\n                        result.lineName = d.name;\n                        return result;\n                    });\n                    result.push({\n                        name: d.name,\n                        data: data,\n                        states: {\n                            hover: {\n                                lineWidth: 10,\n                            }\n                        }\n                    })\n                });\n                return result;\n            };\n            $scope.computePerHoursSeries = function () {\n                var perHour = {};\n                var hoursMapping = {}\n                hoursList.forEach(function(e) {\n                    e.values.forEach(function(h) {\n                        hoursMapping[h] = e;\n                    })\n                });\n                $scope.stat.forEach(function (st) {\n                    var hour_key = hoursMapping[st.hour_local].name;\n                    var key = st.stop_id + '-' + hour_key;\n                    perHour[key] = perHour[key] || {\n                            num_trips: 0,\n                            arrival_late_count: 0\n                        };\n                    perHour[key].num_trips += st.num_trips;\n                    perHour[key].arrival_late_count += st.arrival_late_count;\n\n                });\n                var result = [];\n                hoursList.forEach(function (hl) {\n                    var data = $scope.actualFromToStops().map(function (st) {\n                        var entry = perHour[st.id + '-' + hl.name];\n                        var result = {};\n                        if (!entry) {\n                            // console.log('no entry for ' + st.id + ' ' + hl.name);\n                            result.y = 0;\n                            result.numTrips = 0;\n                        } else {\n                            result.y = entry.arrival_late_count * 100.0 / entry.num_trips;\n                            result.numTrips = entry.num_trips;\n                        }\n                        result.lineName = hl.name;\n                        return result;\n                    });\n                    result.push({\n                        name: hl.name,\n                        data: data,\n                        states: {\n                            hover: {\n                                lineWidth: 10,\n                            }\n                        }\n                    })\n                });\n                return result;\n            }\n            $scope.updateChart = function () {\n                var stopNames = $scope.actualFromToStops().map(function (st, idx) {\n                    return st.name + ' - ' + (idx + 1);\n                });\n                $scope.perDaySeries = $scope.computePerDaySeries();\n                $scope.perHoursSeries = $scope.computePerHoursSeries();\n\n                var tooltip = {\n                    formatter: function () {\n                        var prec = Math.round(this.y * 100) / 100;\n                        return '<span dir=\"rtl\"><b>' + this.x + '</b>' + '<br/>' +\n                                '<span>' + this.point.lineName + '</span><br/>' +\n                            '<span>רכבות מאחרות:</span>' + prec + '%' + '<br/>' +\n                            '<span>מספר רכבות: </span>' + this.point.numTrips +\n                            '</span>';\n                    },\n                    useHTML: true,\n                };\n                window.scope = $scope;\n                $scope.chartPerDay = {\n                    plotOptions: {\n                        series: {\n                            line: {\n                                states: {\n                                    hover: {\n                                        lineWidth: 20,\n                                    }\n                                }\n                            }\n                        }\n                    },\n                    options: {\n                        chart: {\n                            type: 'line'\n                        },\n                        title: {\n                            text: 'איחור בחתך יומי'\n                        },\n                        tooltip: tooltip,\n                    },\n                    xAxis: {\n                        reversed: true,\n                        categories: stopNames,\n                        useHTML: true,\n                    },\n                    yAxis: {\n                        opposite: true,\n                        useHTML: true,\n                        title: {\n                            text: 'אחוזי איחור'\n                        }\n                    },\n                    series: $scope.perDaySeries,\n                };\n                $scope.chartPerHour = {\n                    options: {\n                        chart: {\n                            type: 'line'\n                        },\n                        title: {\n                            text: 'אישור בחתך שעתי'\n                        },\n                        tooltip: tooltip,\n                    },\n                    yAxis: {\n                        useHTML: true,\n                        opposite: true,\n                        title: {\n                            text: 'אחוזי איחור'\n                        }\n                    },\n                    xAxis: {\n                        useHTML: true,\n                        reversed: true,\n                        categories: stopNames,\n                    },\n                    tooltip: {\n                        useHTML: true\n                    },\n                    series: $scope.perHoursSeries,\n                };\n            };\n            $scope.findDate = function (dates, value) {\n                for (var i = 0; i < dates.length; i++) {\n                    if (dates[i].value == value) {\n                        return dates[i];\n                    }\n                }\n                return null;\n            };\n\n            $scope.initData().then(() => {\n                let params = $location.search();\n                $scope.input.startDate = $scope.findDate($scope.startDates, params.startDate) || $scope.startDates[$scope.startDates.length - 1];\n                $scope.input.endDate = $scope.findDate($scope.endDates, params.endDate) || $scope.endDates[$scope.endDates.length - 1];\n                $scope.input.startStop = Layout.findStop(params.startStop || 400);\n                $scope.input.endStop = Layout.findStop(params.endStop || 3700)\n                $scope.refresh();\n            });\n        });\n\n\n\n\n\n","'use strict';\n\n(function () {\n    var app = angular.module('RouteExplorer', ['ngRoute', 'ui.bootstrap', 'ui.bootstrap.buttons', 'leaflet-directive', \"highcharts-ng\"]);\n\n    app.constant('env', {\n        baseDir: '/static/ui/RouteExplorer'\n    });\n\n    app.config(['$routeProvider', 'env', function ($routeProvider, env) {\n\n        var templateUrl = function templateUrl(templateName) {\n            return env.baseDir + '/tpls/' + templateName + '.html';\n        };\n\n        $routeProvider.when('/', {\n            pageId: 'welcome',\n            templateUrl: templateUrl('SelectStops'),\n            controller: 'SelectStopsController',\n            resolve: { 'Layout': 'Layout' }\n        }).when('/about', {\n            pageId: 'about',\n            templateUrl: templateUrl('About')\n        }).when('/:period/select-route/:origin/:destination', {\n            pageId: 'routes',\n            templateUrl: templateUrl('SelectRoute'),\n            controller: 'SelectRouteController',\n            resolve: { 'Layout': 'Layout' },\n            reloadOnSearch: false\n        }).when('/:period/routes/:routeId', {\n            pageId: 'route',\n            templateUrl: templateUrl('RouteDetails'),\n            controller: 'RouteDetailsController',\n            resolve: { 'Layout': 'Layout' },\n            reloadOnSearch: false\n        }).when(\"/heat-map\", {\n            pageId: 'heatMap',\n            templateUrl: templateUrl('HeatMap'),\n            controller: 'HeatMapController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).when(\"/graphs\", {\n            pageId: 'graphs',\n            templateUrl: templateUrl('Graphs'),\n            controller: 'GraphsController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).when(\"/routes\", {\n            pageId: 'routes',\n            templateUrl: templateUrl('RealRoutes'),\n            controller: 'RealRoutesController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).when(\"/highlights\", {\n            pageId: 'highlights',\n            templateUrl: templateUrl('Highlights'),\n            controller: 'HighlightsController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).when(\"/top-highlights\", {\n            pageId: 'top_highlights',\n            templateUrl: templateUrl('TopHighlights'),\n            controller: 'TopHighlightsController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).when(\"/trip-details\", {\n            pageId: 'trip_details',\n            templateUrl: templateUrl('TripDetails'),\n            controller: 'TripDetailsController',\n            reloadOnSearch: false,\n            resolve: { 'Layout': 'Layout' }\n        }).otherwise({\n            redirectTo: '/'\n        });\n    }]);\n})();\n'use strict';\n\n// String.repeat polyfill\n// taken from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/repeat#Polyfill\nif (!String.prototype.repeat) {\n  String.prototype.repeat = function (count) {\n    'use strict';\n\n    if (this === null) {\n      throw new TypeError('can\\'t convert ' + this + ' to object');\n    }\n    var str = '' + this;\n    count = +count;\n    if (count != count) {\n      count = 0;\n    }\n    if (count < 0) {\n      throw new RangeError('repeat count must be non-negative');\n    }\n    if (count == Infinity) {\n      throw new RangeError('repeat count must be less than infinity');\n    }\n    count = Math.floor(count);\n    if (str.length === 0 || count === 0) {\n      return '';\n    }\n    // Ensuring count is a 31-bit integer allows us to heavily optimize the\n    // main part. But anyway, most current (August 2014) browsers can't handle\n    // strings 1 << 28 chars or longer, so:\n    if (str.length * count >= 1 << 28) {\n      throw new RangeError('repeat count must not overflow maximum string size');\n    }\n    var rpt = '';\n    for (;;) {\n      if ((count & 1) == 1) {\n        rpt += str;\n      }\n      count >>>= 1;\n      if (count === 0) {\n        break;\n      }\n      str += str;\n    }\n    return rpt;\n  };\n}\n'use strict';\n\nangular.module('RouteExplorer').controller('AppController', [\"$scope\", \"$location\", function ($scope, $location) {\n    'ngInject';\n\n    $scope.share = function (prefix) {\n        var url = prefix + encodeURIComponent('http://otrain.org/#' + $location.url());\n        window.open(url, 'sharePopup', 'width=600,height=550,top=100,left=100,location=no,scrollbar=no,status=no,menubar=no');\n    };\n\n    $scope.$on('$routeChangeSuccess', function (e, route) {\n        $scope.bodyClass = route.pageId ? 'rex-page-' + route.pageId : null;\n    });\n}]);\n'use strict';\n\nangular.module('RouteExplorer').constant('daysTable', [{\n    value: 0,\n    name: 'ראשון'\n}, {\n    value: 1,\n    name: 'שני'\n}, {\n    value: 2,\n    name: 'שלישי'\n}, {\n    value: 3,\n    name: 'רביעי'\n}, {\n    value: 4,\n    name: 'חמישי'\n}, {\n    value: 5,\n    name: 'שישי'\n}, {\n    value: 6,\n    name: 'שבת'\n}])\n//}], {\n//    value: 'all',\n//    name: 'שבועי'\n//}\n//])\n.constant(\"monthNames\", ['dummy', 'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר']).constant(\"hoursList\", [{\n    name: '4-7',\n    values: [4, 5, 6]\n}, {\n    name: '7-9',\n    values: [7, 8]\n}, {\n    name: '9-12',\n    values: [9, 10, 11]\n}, {\n    name: '12-15',\n    values: [12, 13, 14]\n}, {\n    name: '15-18',\n    values: [15, 16, 17]\n}, {\n    name: '18-21',\n    values: [18, 19, 20]\n}, {\n    name: '21-24',\n    values: [21, 22, 23]\n}, {\n    name: '24-4',\n    values: [0, 1, 2, 3]\n}]);\n\nangular.module('RouteExplorer').controller('GraphsController', [\"$scope\", \"$http\", \"$q\", \"$timeout\", \"$location\", \"Layout\", \"daysTable\", \"hoursList\", \"monthNames\", function ($scope, $http, $q, $timeout, $location, Layout, daysTable, hoursList, monthNames) {\n    'ngInject';\n\n    $scope.wip = true;\n    $scope.Layout = Layout;\n    $scope.input = {\n        graphKind: 'perDay'\n    };\n    $scope.updateSkipped = function () {\n        $scope.refresh({ 'skippedCall': true });\n    };\n\n    $scope.isMustSkipChecked = function () {\n        if (!$scope.fromToStops) {\n            return false;\n        }\n        return $scope.fromToStops.some(function (st) {\n            return st.mustSkip;\n        });\n    };\n\n    $scope.actualFromToStops = function () {\n        var _this = this;\n\n        return $scope.fromToStops.filter(function (st) {\n            return _this.mustSkipComplementMode || !st.mustSkip;\n        });\n    };\n\n    $scope.skippedToggleAll = function () {\n        var hasSelected = $scope.fromToStops.some(function (st) {\n            return st.mustSkip;\n        });\n        $scope.fromToStops.forEach(function (st, idx) {\n            if (idx > 0 && idx < $scope.fromToStops.length - 1) {\n                st.mustSkip = !hasSelected;\n            }\n        });\n    };\n\n    $scope.getSkipped = function () {\n        if (!$scope.fromToStops) {\n            return undefined;\n        }\n        return $scope.fromToStops.filter(function (st) {\n            return st.mustSkip;\n        }).map(function (st) {\n            return st.id;\n        }).join(\",\");\n    };\n\n    $scope.refresh = function (config) {\n        config = config || {};\n        $scope.wip = true;\n        $scope.startStop = $scope.input.startStop;\n        $scope.endStop = $scope.input.endStop;\n        $scope.startDate = $scope.input.startDate.value;\n        $scope.endDate = $scope.input.endDate.value;\n        $location.search({\n            startStop: $scope.startStop.id,\n            endStop: $scope.endStop.id,\n            startDate: $scope.startDate,\n            endDate: $scope.endDate\n        });\n        $scope.stops = Layout.getStops();\n        $scope.stopsById = {};\n        $scope.stops.forEach(function (st) {\n            $scope.stopsById[st.id] = st;\n        });\n        var cbs = [$http.get('/api/v1/stats/from-to-full/', {\n            params: {\n                from_date: $scope.startDate,\n                to_date: $scope.endDate,\n                from_stop: $scope.startStop.id,\n                to_stop: $scope.endStop.id,\n                skipped: config.skippedCall ? $scope.getSkipped() : undefined,\n                skipped_complement: $scope.mustSkipComplementMode ? '1' : '0'\n            }\n        }).then(function (resp) {\n            $scope.stat = resp.data.table;\n        })];\n        if (!config.skippedCall) {\n            cbs.push($http.get('/api/v1/stops/from-to/', {\n                params: {\n                    from_stop: $scope.startStop.id,\n                    to_stop: $scope.endStop.id\n                }\n            }).then(function (resp) {\n                $scope.fromToStopsIds = resp.data;\n                $scope.fromToStops = $scope.fromToStopsIds.map(function (stopId) {\n                    return $scope.stopsById[stopId];\n                });\n                var _iteratorNormalCompletion = true;\n                var _didIteratorError = false;\n                var _iteratorError = undefined;\n\n                try {\n                    for (var _iterator = $scope.fromToStops[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                        var st = _step.value;\n\n                        st.mustSkip = false;\n                    }\n                } catch (err) {\n                    _didIteratorError = true;\n                    _iteratorError = err;\n                } finally {\n                    try {\n                        if (!_iteratorNormalCompletion && _iterator.return) {\n                            _iterator.return();\n                        }\n                    } finally {\n                        if (_didIteratorError) {\n                            throw _iteratorError;\n                        }\n                    }\n                }\n            }));\n        }\n        $q.all(cbs).then(function () {\n            $scope.wip = false;\n            $scope.updateChart();\n        });\n    };\n    $scope.getRouteTitle = function (route) {\n        return 'מ' + route.from + ' ל' + route.to + ' (' + route.count + ' ' + 'נסיעות' + ')';\n    };\n\n    $scope.initData = function () {\n        return $scope.buildDates();\n    };\n\n    $scope.buildDates = function () {\n        return $http.get('/api/v1/general/dates-range').then(function (resp) {\n            var data = resp.data;\n            var s = [data.first_date.month, data.first_date.year];\n            var e = [data.last_date.month, data.last_date.year];\n            $scope.buildDatesRange(s, e);\n        });\n    };\n    $scope.buildDatesRange = function (s, e) {\n        $scope.startDates = [];\n        $scope.endDates = [];\n        while (true) {\n            var abort = false;\n            $scope.startDates.push({\n                name: monthNames[s[0]] + ' ' + s[1],\n                value: '1-' + s[0] + '-' + s[1]\n            });\n            var ns = s[0] == 12 ? [1, s[1] + 1] : [s[0] + 1, s[1]];\n            $scope.endDates.push({\n                name: monthNames[s[0]] + ' ' + s[1],\n                value: '1-' + ns[0] + '-' + ns[1]\n            });\n            if ($scope.startDates.length > 100) {\n                alert(\"error\");\n                return;\n            }\n            if (s[0] == e[0] && s[1] == e[1]) {\n                return;\n            }\n            s = [ns[0], ns[1]];\n        }\n    };\n    $scope.computePerDaySeries = function () {\n        var perDay = {};\n        $scope.stat.forEach(function (st) {\n            var key = st.stop_id + '-' + st.week_day_local;\n            perDay[key] = perDay[key] || {\n                num_trips: 0,\n                arrival_late_count: 0\n            };\n            perDay[key].num_trips += st.num_trips;\n            perDay[key].arrival_late_count += st.arrival_late_count;\n        });\n        var result = [];\n        daysTable.forEach(function (d) {\n            var data = $scope.actualFromToStops().map(function (st) {\n                var entry = perDay[st.id + '-' + d.value];\n                var result = {};\n                if (!entry) {\n                    result.y = 0;\n                    result.numTrips = 0;\n                    //console.log('no entry for ' + st.id + ' ' + d.value);\n                } else {\n                    result.y = entry.arrival_late_count * 100.0 / entry.num_trips;\n                    result.numTrips = entry.num_trips;\n                }\n                result.lineName = d.name;\n                return result;\n            });\n            result.push({\n                name: d.name,\n                data: data,\n                states: {\n                    hover: {\n                        lineWidth: 10\n                    }\n                }\n            });\n        });\n        return result;\n    };\n    $scope.computePerHoursSeries = function () {\n        var perHour = {};\n        var hoursMapping = {};\n        hoursList.forEach(function (e) {\n            e.values.forEach(function (h) {\n                hoursMapping[h] = e;\n            });\n        });\n        $scope.stat.forEach(function (st) {\n            var hour_key = hoursMapping[st.hour_local].name;\n            var key = st.stop_id + '-' + hour_key;\n            perHour[key] = perHour[key] || {\n                num_trips: 0,\n                arrival_late_count: 0\n            };\n            perHour[key].num_trips += st.num_trips;\n            perHour[key].arrival_late_count += st.arrival_late_count;\n        });\n        var result = [];\n        hoursList.forEach(function (hl) {\n            var data = $scope.actualFromToStops().map(function (st) {\n                var entry = perHour[st.id + '-' + hl.name];\n                var result = {};\n                if (!entry) {\n                    // console.log('no entry for ' + st.id + ' ' + hl.name);\n                    result.y = 0;\n                    result.numTrips = 0;\n                } else {\n                    result.y = entry.arrival_late_count * 100.0 / entry.num_trips;\n                    result.numTrips = entry.num_trips;\n                }\n                result.lineName = hl.name;\n                return result;\n            });\n            result.push({\n                name: hl.name,\n                data: data,\n                states: {\n                    hover: {\n                        lineWidth: 10\n                    }\n                }\n            });\n        });\n        return result;\n    };\n    $scope.updateChart = function () {\n        var stopNames = $scope.actualFromToStops().map(function (st, idx) {\n            return st.name + ' - ' + (idx + 1);\n        });\n        $scope.perDaySeries = $scope.computePerDaySeries();\n        $scope.perHoursSeries = $scope.computePerHoursSeries();\n\n        var tooltip = {\n            formatter: function formatter() {\n                var prec = Math.round(this.y * 100) / 100;\n                return '<span dir=\"rtl\"><b>' + this.x + '</b>' + '<br/>' + '<span>' + this.point.lineName + '</span><br/>' + '<span>רכבות מאחרות:</span>' + prec + '%' + '<br/>' + '<span>מספר רכבות: </span>' + this.point.numTrips + '</span>';\n            },\n            useHTML: true\n        };\n        window.scope = $scope;\n        $scope.chartPerDay = {\n            plotOptions: {\n                series: {\n                    line: {\n                        states: {\n                            hover: {\n                                lineWidth: 20\n                            }\n                        }\n                    }\n                }\n            },\n            options: {\n                chart: {\n                    type: 'line'\n                },\n                title: {\n                    text: 'איחור בחתך יומי'\n                },\n                tooltip: tooltip\n            },\n            xAxis: {\n                reversed: true,\n                categories: stopNames,\n                useHTML: true\n            },\n            yAxis: {\n                opposite: true,\n                useHTML: true,\n                title: {\n                    text: 'אחוזי איחור'\n                }\n            },\n            series: $scope.perDaySeries\n        };\n        $scope.chartPerHour = {\n            options: {\n                chart: {\n                    type: 'line'\n                },\n                title: {\n                    text: 'אישור בחתך שעתי'\n                },\n                tooltip: tooltip\n            },\n            yAxis: {\n                useHTML: true,\n                opposite: true,\n                title: {\n                    text: 'אחוזי איחור'\n                }\n            },\n            xAxis: {\n                useHTML: true,\n                reversed: true,\n                categories: stopNames\n            },\n            tooltip: {\n                useHTML: true\n            },\n            series: $scope.perHoursSeries\n        };\n    };\n    $scope.findDate = function (dates, value) {\n        for (var i = 0; i < dates.length; i++) {\n            if (dates[i].value == value) {\n                return dates[i];\n            }\n        }\n        return null;\n    };\n\n    $scope.initData().then(function () {\n        var params = $location.search();\n        $scope.input.startDate = $scope.findDate($scope.startDates, params.startDate) || $scope.startDates[$scope.startDates.length - 1];\n        $scope.input.endDate = $scope.findDate($scope.endDates, params.endDate) || $scope.endDates[$scope.endDates.length - 1];\n        $scope.input.startStop = Layout.findStop(params.startStop || 400);\n        $scope.input.endStop = Layout.findStop(params.endStop || 3700);\n        $scope.refresh();\n    });\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('HeatMapController', [\"$scope\", \"$http\", \"Layout\", function ($scope, $http, Layout) {\n    \"ngInject\";\n\n    $scope.Layout = Layout;\n    var ta = $scope.Layout.findStop(4600); // TA HASHALOM\n    console.log(ta);\n    angular.extend($scope, {\n        defaults: {\n            scrollWheelZoom: false\n        },\n        center: {\n            lat: ta.latlon[0],\n            lng: ta.latlon[1],\n            zoom: 10\n        }\n    });\n    $scope.stops = Layout.getStops();\n    $scope.input = {\n        stop: $scope.stops[0]\n    };\n    $scope.paths = [];\n    $http.get('/api/v1/heat-map/').then(function (resp) {\n        $scope.heatmapData = resp.data;\n        //var maxScore = 0;\n        //var minScore = 1;\n\n        //$scope.heatmapData.forEach(function(score) {\n        //    maxScore = Math.max(score.score, maxScore);\n        //    minScore = Math.min(score.score, minScore);\n        //});\n\n        $scope.heatmapData.forEach(function (score) {\n            var latlng = $scope.Layout.findStop(score.stop_id).latlon;\n            var g = 255 - Math.floor(255 * score.score);\n            var color = 'rgb(255,' + g + ',0)';\n            var message = $scope.Layout.findStop(score.stop_id).name + '<br/>' + Math.floor(score.score * 100) / 100;\n            $scope.paths.push({\n                color: color,\n                fillColor: color,\n                fillOpacity: 1,\n                type: \"circleMarker\",\n                stroke: false,\n                radius: 10,\n                latlngs: latlng,\n                message: message,\n                popupOptions: {\n                    className: 'ot-popup'\n                }\n            });\n        });\n    });\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('HighlightsController', [\"$scope\", \"$http\", \"$q\", \"$timeout\", \"$location\", \"Layout\", \"daysTable\", \"hoursList\", \"monthNames\", function ($scope, $http, $q, $timeout, $location, Layout, daysTable, hoursList, monthNames) {\n    'ngInject';\n\n    $scope.init = function () {\n        $http.get(\"/api/v1/highlights/\").then(function (resp) {\n            $scope.highlights = resp.data.highlights;\n            $scope.url = resp.data.url;\n            $scope.fields = [{\n                name: 'תאריך',\n                sortKey: function sortKey(v) {\n                    return v.year * 100 + v.month;\n                }\n            }, {\n                name: 'מספר נסיעות',\n                sortKey: function sortKey(v) {\n                    return v.num_trips;\n                },\n                initialDesc: true\n            }, {\n                name: 'יום בשבוע',\n                sortKey: function sortKey(v) {\n                    if (v.week_day == 'all') {\n                        return -1;\n                    }\n                    return v.week_day;\n                }\n            }, {\n                name: 'שעות',\n                sortKey: function sortKey(v) {\n                    if (v.hours == 'all') {\n                        return -1;\n                    }\n                    return v.hours[1];\n                }\n            }, {\n                name: '% איחורים מעל 5 דקות',\n                active: true,\n                asc: false,\n                initialDesc: true,\n                sortKey: function sortKey(v) {\n                    return v.mean_arrival_late_pct;\n                }\n            }, {\n                name: 'קישור',\n                disableSort: true\n            }];\n            $scope.refresh();\n        });\n    };\n    $scope.sortBy = function (activeField) {\n        var _iteratorNormalCompletion = true;\n        var _didIteratorError = false;\n        var _iteratorError = undefined;\n\n        try {\n            for (var _iterator = $scope.fields[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                var f = _step.value;\n\n                if (f != activeField) {\n                    f.active = false;\n                }\n            }\n        } catch (err) {\n            _didIteratorError = true;\n            _iteratorError = err;\n        } finally {\n            try {\n                if (!_iteratorNormalCompletion && _iterator.return) {\n                    _iterator.return();\n                }\n            } finally {\n                if (_didIteratorError) {\n                    throw _iteratorError;\n                }\n            }\n        }\n\n        if (activeField.active) {\n            activeField.asc = !activeField.asc;\n        } else {\n            activeField.active = true;\n            activeField.asc = !activeField.initialDesc;\n        }\n        $scope.refresh();\n    };\n    $scope.refresh = function () {\n        var activeField = null;\n        var _iteratorNormalCompletion2 = true;\n        var _didIteratorError2 = false;\n        var _iteratorError2 = undefined;\n\n        try {\n            for (var _iterator2 = $scope.fields[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n                var f = _step2.value;\n\n                if (f.active) {\n                    activeField = f;\n                }\n            }\n        } catch (err) {\n            _didIteratorError2 = true;\n            _iteratorError2 = err;\n        } finally {\n            try {\n                if (!_iteratorNormalCompletion2 && _iterator2.return) {\n                    _iterator2.return();\n                }\n            } finally {\n                if (_didIteratorError2) {\n                    throw _iteratorError2;\n                }\n            }\n        }\n\n        if (!activeField) {\n            return;\n        }\n        $scope.highlights.sort(function (v1, v2) {\n            var k1 = activeField.sortKey(v1);\n            var k2 = activeField.sortKey(v2);\n            var asc = activeField.asc ? 1 : -1;\n            if (k1 > k2) {\n                return 1 * asc;\n            }\n            if (k1 < k2) {\n                return -1 * asc;\n            }\n            return 0;\n        });\n    };\n    $scope.init();\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('RouteDetailsController', [\"$scope\", \"$route\", \"$http\", \"$location\", \"LocationBinder\", \"Layout\", \"Locale\", \"TimeParser\", function ($scope, $route, $http, $location, LocationBinder, Layout, Locale, TimeParser) {\n    \"ngInject\";\n\n    var routeParams = $route.current.params;\n\n    var period = TimeParser.parsePeriod(routeParams.period);\n    var startDate = TimeParser.createRequestString(period.from);\n    var endDate = TimeParser.createRequestString(period.end);\n\n    var routeId = routeParams.routeId;\n    var stopIds = Layout.findRoute(routeId).stops;\n    var statsMap = {};\n\n    $scope.loaded = false;\n    $scope.stopIds = stopIds;\n    $scope.origin = stopIds[0];\n    $scope.destination = stopIds[stopIds.length - 1];\n\n    $scope.selectedPeriod = formatMonth(period.from);\n    if (period.to > period.from) {\n        $scope.selectedPeriod += ' \\u2014 ' + formatMonth(period.to);\n    }\n\n    $scope.selectedDay = null;\n    $scope.days = Locale.days;\n\n    $scope.selectedTime = null;\n    $scope.times = [];\n\n    $scope.selectRouteUrl = '#/' + routeParams.period + '/select-route/' + $scope.origin + '/' + $scope.destination;\n\n    var previousPeriod = offsetPeriod(period, -1);\n    var nextPeriod = offsetPeriod(period, +1);\n    var bounds = Layout.getRoutesDateRange();\n    var day = 10 * 24 * 60 * 60 * 1000;\n    $scope.previousPeriodUrl = bounds.min.getTime() - day < previousPeriod.from.getTime() ? '#/' + TimeParser.formatPeriod(previousPeriod) + '/routes/' + routeId : null;\n    $scope.nextPeriodUrl = bounds.max > nextPeriod.to ? '#/' + TimeParser.formatPeriod(nextPeriod) + '/routes/' + routeId : null;\n\n    $http.get('/api/v1/stats/route-info-full', { params: { route_id: routeId, from_date: startDate, to_date: endDate } }).success(function (data) {\n        loadStats(data);\n        $scope.loaded = true;\n    });\n\n    LocationBinder.bind($scope, 'selectedDay', 'day', function (val) {\n        return val ? Number(val) : null;\n    });\n    LocationBinder.bind($scope, 'selectedTime', 'time');\n\n    $scope.stopStats = function (stopId) {\n        var stats = selectedStats();\n        for (var i in stats) {\n            if (stats[i].stop_id == stopId) return stats[i];\n        }\n        return null;\n    };\n\n    $scope.stopName = function (stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop) return null;\n\n        return stop.name;\n    };\n\n    $scope.isDayEmpty = function (day) {\n        var dayId = day.id;\n        var dayTimes = statsMap[dayId];\n\n        if (!dayTimes) return true;\n\n        for (var time in dayTimes) {\n            if (dayTimes[time].info.num_trips > 0) return false;\n        }return true;\n    };\n\n    $scope.isTimeEmpty = function (time) {\n        var dayId = $scope.selectedDay || 'all';\n        var timeId = time.id;\n\n        var timeStats = statsMap[dayId] && statsMap[dayId][timeId];\n        if (timeStats && timeStats.info.num_trips > 0) return false;\n\n        return true;\n    };\n\n    $scope.tripCount = function (dayId, timeId) {\n        var stats = getStats(dayId, timeId);\n        if (!stats) return 0;\n\n        return stats.info.num_trips;\n    };\n\n    function getStats(dayId, timeId) {\n        dayId = dayId || 'all';\n        timeId = timeId || 'all';\n        return statsMap[dayId] && statsMap[dayId][timeId] ? statsMap[dayId][timeId] : null;\n    }\n\n    function selectedStats() {\n        var stats = getStats($scope.selectedDay, $scope.selectedTime);\n        if (stats) return stats.stops;\n\n        return [];\n    }\n\n    function loadStats(data) {\n        $scope.times = [];\n        var timesMap = {};\n\n        for (var i in data) {\n            var statGroup = data[i];\n            var timeId = statGroup.info.hours == 'all' ? 'all' : statGroup.info.hours[0] + '-' + statGroup.info.hours[1];\n            var dayId = statGroup.info.week_day;\n\n            if (!statsMap[dayId]) statsMap[dayId] = {};\n\n            statsMap[dayId][timeId] = statGroup;\n\n            if (timeId != 'all' && !timesMap[timeId]) {\n                var time = {\n                    id: timeId,\n                    from: formatHour(statGroup.info.hours[0]),\n                    to: formatHour(statGroup.info.hours[1])\n                };\n                timesMap[timeId] = time;\n                $scope.times.push(time);\n            }\n        }\n    }\n\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear();\n    }\n\n    function offsetMonth(date, offset) {\n        var d = new Date(date);\n        d.setMonth(d.getMonth() + offset);\n        return d;\n    }\n\n    function offsetPeriod(period, offset) {\n        var size = (period.to.getFullYear() - period.from.getFullYear()) * 12 + period.to.getMonth() - period.from.getMonth() + 1;\n\n        return {\n            from: offsetMonth(period.from, size * offset),\n            to: offsetMonth(period.to, size * offset),\n            end: offsetMonth(period.end, size * offset)\n        };\n    }\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('RealRoutesController', [\"$scope\", \"$http\", \"$q\", \"$timeout\", \"$location\", \"Layout\", \"daysTable\", \"hoursList\", \"monthNames\", function ($scope, $http, $q, $timeout, $location, Layout, daysTable, hoursList, monthNames) {\n    'ngInject';\n\n    $scope.selectedYear = 2017;\n    $scope.selectedMonth = 9;\n    $scope.getMonths = function () {\n        return [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];\n    };\n    $scope.getYears = function () {\n        var result = [];\n        var lastYear = new Date().getFullYear();\n        var y = 2015;\n        while (y <= lastYear) {\n            result.push(y);\n            y++;\n        }\n        return result;\n    };\n    $scope.init = function () {\n        $scope.months = $scope.getMonths();\n        $scope.years = $scope.getYears();\n    };\n    $scope.refresh = function () {\n        $scope.realRoutes = null;\n        var y = $scope.selectedYear;\n        var m = $scope.selectedMonth;\n        $http.get('/api/v1/real-routes/' + y + '/' + m + '/').then(function (resp) {\n            $scope.realRoutes = resp.data;\n            var _iteratorNormalCompletion = true;\n            var _didIteratorError = false;\n            var _iteratorError = undefined;\n\n            try {\n                for (var _iterator = $scope.realRoutes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                    var rr = _step.value;\n\n                    console.log(rr);\n                    rr.firstStop = rr.stops[0];\n                    rr.lastStop = rr.stops[rr.stops.length - 1];\n                }\n            } catch (err) {\n                _didIteratorError = true;\n                _iteratorError = err;\n            } finally {\n                try {\n                    if (!_iteratorNormalCompletion && _iterator.return) {\n                        _iterator.return();\n                    }\n                } finally {\n                    if (_didIteratorError) {\n                        throw _iteratorError;\n                    }\n                }\n            }\n        });\n    };\n    $scope.init();\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('SelectRouteController', [\"$scope\", \"$http\", \"$location\", \"$route\", \"Layout\", \"TimeParser\", function ($scope, $http, $location, $route, Layout, TimeParser) {\n    'ngInject';\n\n    $scope.stops = Layout.getStops();\n    var period = TimeParser.parsePeriod($route.current.params.period);\n    var origin = Layout.findStop($route.current.params.origin);\n    var destination = Layout.findStop($route.current.params.destination);\n\n    var graphsUrlParams = ['startStop=' + origin.id, 'endStop=' + destination.id, 'startDate=' + TimeParser.createRequestString(period.from, '-'), 'endDate=' + TimeParser.createRequestString(period.end, '-')];\n    $scope.graphsUrl = \"#/graphs?\" + graphsUrlParams.join(\"&\");\n\n    $http.get('/api/v1/stats/path-info-full/', { params: {\n            origin: origin.id,\n            destination: destination.id,\n            from_date: TimeParser.createRequestString(period.from),\n            to_date: TimeParser.createRequestString(period.end) }\n    }).success(function (data) {\n        loadStats(data);\n        $scope.loaded = true;\n    });\n\n    var statsMap = {};\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear();\n    }\n\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n    function loadStats(data) {\n        $scope.stats = data;\n    }\n\n    Layout.findRoutesByPeriod(origin.id, destination.id, period.from, period.end).then(function (routes) {\n        $scope.routes = routes;\n    });\n\n    function stopName(stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop) return null;\n\n        return stop.name;\n    }\n\n    $scope.isOrigin = function (stopId) {\n        return stopId == origin.id;\n    };\n\n    $scope.isDestination = function (stopId) {\n        return stopId == destination.id;\n    };\n\n    $scope.stopText = function (stopId) {\n        return stopName(stopId);\n    };\n\n    $scope.barWidth = function (route) {\n        var percentWidth = route.count * 100.0 / $scope.routes[0].count;\n\n        if (percentWidth < 1.0) return \"1px\";\n\n        return percentWidth + \"%\";\n    };\n\n    $scope.routeUrl = function (route) {\n        return '/#/' + $route.current.params.period + '/routes/' + route.id;\n    };\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('SelectStopsController', ['$scope', '$rootScope', '$location', 'Layout', 'Locale', 'TimeParser', function ($scope, $rootScope, $location, Layout, Locale, TimeParser) {\n    'ngInject';\n\n    $scope.stops = Layout.getStops();\n    $scope.origin = null;\n    $scope.destination = null;\n    $scope.months = Locale.months;\n\n    var dateRange = Layout.getRoutesDateRange();\n    $scope.periods = generatePeriods(dateRange.min, dateRange.max);\n    $scope.startPeriod = $scope.periods[0];\n    $scope.endPeriod = $scope.periods[0];\n\n    $scope.formValid = function () {\n        return !!$scope.origin && !!$scope.destination && $scope.origin != $scope.destination && $scope.startPeriod.from <= $scope.endPeriod.to;\n    };\n\n    $scope.stopName = function (stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop) return null;\n\n        return stop.name;\n    };\n\n    $scope.goToRoutes = function () {\n        $scope.noRoutes = false;\n        $scope.loading = true;\n        var period = {\n            from: $scope.startPeriod.from,\n            to: $scope.endPeriod.to,\n            end: $scope.endPeriod.end\n        };\n        var fromDate = period.from;\n        var toDate = period.end;\n        var periodStr = TimeParser.formatPeriod(period);\n        Layout.findRoutesByPeriod($scope.origin.id, $scope.destination.id, fromDate, toDate).then(function (routes) {\n            if (routes.length === 0) {\n                $scope.noRoutes = true;\n            } else if (routes.length == 1) {\n                $location.path('/' + periodStr + '/routes/' + routes[0].id);\n            } else {\n                $location.path('/' + periodStr + '/select-route/' + $scope.origin.id + '/' + $scope.destination.id);\n            }\n        }).finally(function () {\n            $scope.loading = false;\n        });\n    };\n\n    $scope.dismissError = function () {\n        $scope.noRoutes = false;\n    };\n\n    function generatePeriods(fromDate, toDate) {\n        // fromDate=1970-1-1 due to a data bug. This is a quick temporary workaround\n        if (fromDate.getFullYear() < 2013) fromDate = new Date(2013, 0, 1);\n\n        var periods = [];\n        var start = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);\n        while (start < toDate) {\n            var end = new Date(start.getFullYear(), start.getMonth() + 1, start.getDate());\n            var period = {\n                from: start,\n                to: start,\n                end: end,\n                name: Locale.months[start.getMonth()].name + \" \" + start.getFullYear()\n            };\n            period.toName = Locale.until + period.name;\n            periods.push(period);\n            start = end;\n        }\n        periods.reverse();\n        return periods;\n    }\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('TimesDetailsController', [\"$scope\", \"$route\", \"Locale\", \"LocationBinder\", \"Layout\", function ($scope, $route, Locale, LocationBinder, Layout) {\n    'ngInject';\n\n    Layout.then(function (Layout) {\n        $scope.layout = Layout;\n    });\n    $scope.layout = null;\n\n    var statsMap = {};\n    var routeParams = $route.current.params;\n    $scope.stopIds = [parseInt(routeParams.origin), parseInt(routeParams.destination)];\n    LocationBinder.bind($scope, 'selectedDay', 'day', function (val) {\n        return val ? Number(val) : null;\n    });\n    LocationBinder.bind($scope, 'selectedTime', 'time');\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear();\n    }\n\n    function selectedStats() {\n        var stats = getStats($scope.selectedDay, $scope.selectedTime);\n        if (stats) return stats.stops;\n\n        return [];\n    }\n\n    $scope.stopName = function (stopId) {\n        if ($scope.layout) {\n            var stop = $scope.layout.findStop(stopId);\n            if (!stop) return null;\n\n            return stop.name;\n        } else {\n            return null;\n        }\n    };\n\n    $scope.selectedDay = null;\n    $scope.days = Locale.days;\n\n    $scope.selectedTime = null;\n    $scope.times = [];\n\n    $scope.loadStats = function () {\n        var data = $scope.stats;\n        $scope.times = [];\n        var timesMap = {};\n\n        for (var i in data) {\n            var statGroup = data[i];\n            var timeId = statGroup.info.hours == 'all' ? 'all' : statGroup.info.hours[0] + '-' + statGroup.info.hours[1];\n            var dayId = statGroup.info.week_day;\n\n            if (!statsMap[dayId]) statsMap[dayId] = {};\n\n            statsMap[dayId][timeId] = statGroup;\n\n            if (timeId != 'all' && !timesMap[timeId]) {\n                var time = {\n                    id: timeId,\n                    from: formatHour(statGroup.info.hours[0]),\n                    to: formatHour(statGroup.info.hours[1])\n                };\n                timesMap[timeId] = time;\n                $scope.times.push(time);\n            }\n        }\n    };\n    $scope.tripCount = function (dayId, timeId) {\n        var stats = getStats(dayId, timeId);\n        if (!stats) return 0;\n\n        return stats.info.num_trips;\n    };\n\n    function getStats(dayId, timeId) {\n        dayId = dayId || 'all';\n        timeId = timeId || 'all';\n        return statsMap[dayId] && statsMap[dayId][timeId] ? statsMap[dayId][timeId] : null;\n    }\n\n    $scope.isTimeEmpty = function (time) {\n        var dayId = $scope.selectedDay || 'all';\n        var timeId = time.id;\n\n        var timeStats = statsMap[dayId] && statsMap[dayId][timeId];\n        if (timeStats && timeStats.info.num_trips > 0) return false;\n\n        return true;\n    };\n\n    $scope.stopStats = function (stopId) {\n        var stats = selectedStats();\n        for (var i in stats) {\n            if (stats[i].stop_id == stopId) return stats[i];\n        }\n        return null;\n    };\n\n    $scope.loadStats();\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('TopHighlightsController', [\"$scope\", \"$http\", \"$q\", \"$timeout\", \"$location\", \"Layout\", \"daysTable\", \"hoursList\", \"monthNames\", function ($scope, $http, $q, $timeout, $location, Layout, daysTable, hoursList, monthNames) {\n    'ngInject';\n\n    $scope.init = function () {\n        $http.get(\"/api/v1/highlights/top/\").then(function (resp) {\n            var data = resp.data.highlights;\n            $scope.highlightLists = [{\n                'kind': 'late',\n                'title': 'נסיעה באיחור',\n                'items': data.late,\n                'color': 'danger'\n            }, {\n                'kind': 'ontime',\n                'title': 'נסיעה בזמן',\n                'items': data.ontime,\n                'color': 'success'\n            }];\n        });\n    };\n    $scope.init();\n}]);\n'use strict';\n\nangular.module('RouteExplorer').controller('TripDetailsController', [\"$scope\", \"$http\", \"$q\", \"$timeout\", \"$location\", \"Layout\", function ($scope, $http, $q, $timeout, $location, Layout) {\n    'ngInject';\n\n    $scope.isLegalTripId = function () {\n        var n = $scope.tripId;\n        return !isNaN(parseInt(n)) && !isNaN(n - 0);\n    };\n    $scope.x_fields = [\"x_week_day_local\", \"x_hour_local\", \"x_max_delay_arrival\", \"x_max2_delay_arrival\", \"x_avg_delay_arrival\", \"x_last_delay_arrival\", \"x_before_last_delay_arrival\"];\n\n    $scope.refreshTrip = function () {\n        $location.search({\n            'trip_id': $scope.tripId\n        });\n        $scope.wip = true;\n        $scope.getError = false;\n        $scope.trip = null;\n        $http.get('/api/v1/trips/' + $scope.tripId + '/').then(function (resp) {\n            $scope.trip = resp.data;\n            $scope.wip = false;\n        }, function (resp) {\n            $scope.wip = false;\n            $scope.getError = true;\n        });\n    };\n    $scope.tripId = 343440;\n    $scope.refreshTrip();\n}]);\n'use strict';\n\nangular.module('RouteExplorer').directive(\"rexPercentBar\", ['env', function (env) {\n  return {\n    restrict: 'E',\n    scope: {\n      value: '=value',\n      type: '=type'\n    },\n    templateUrl: env.baseDir + '/tpls/PercentBar.html'\n  };\n}]);\n'use strict';\n\nangular.module('RouteExplorer').directive(\"timesDetails\", ['env', 'Layout', function (env, Layout) {\n    return {\n        restrict: 'E',\n        scope: {\n            stats: '='\n        },\n        controller: 'TimesDetailsController',\n        templateUrl: env.baseDir + '/tpls/TimesDetails.html'\n    };\n}]);\n'use strict';\n\nvar daysTable = {\n    0: 'ראשון',\n    1: 'שני',\n    2: 'שלישי',\n    3: 'רביעי',\n    4: 'חמישי',\n    5: 'שישי',\n    6: 'שבת'\n};\n\nangular.module('RouteExplorer').filter('week_day1', function () {\n    return function (day) {\n        if (day == 'all') {\n            return 'כל הימים';\n        }\n        return daysTable[day - 1] || '??? ' + day;\n    };\n}).filter('week_day0', function () {\n    return function (day) {\n        if (day == 'all') {\n            return 'כל הימים';\n        }\n        return daysTable[day] || '??? ' + day;\n    };\n}).filter('hours', function () {\n    return function (hours) {\n        var fix = function fix(h) {\n            return h >= 24 ? h % 24 : h;\n        };\n        if (hours == 'all') {\n            return 'כל היום';\n        }\n        var h1 = fix(hours[1]);\n        var h0 = fix(hours[0]);\n        return h1 + ' - ' + h0;\n    };\n}).filter('month_name', function () {\n    var months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];\n    return function (m) {\n        return months[m - 1];\n    };\n});\n'use strict';\n\nangular.module('RouteExplorer').filter('duration', function () {\n    return function (seconds) {\n        var negative = false;\n        seconds = Math.trunc(seconds);\n        if (seconds < 0) {\n            negative = true;\n            seconds = -seconds;\n        }\n\n        var minutes = Math.trunc(seconds / 60);\n        seconds -= minutes * 60;\n        var hours = Math.trunc(minutes / 60);\n        minutes -= hours * 60;\n\n        if (seconds < 10) seconds = '0' + seconds;\n        if (minutes < 10 && hours !== 0) minutes = '0' + minutes;\n\n        var res = minutes + ':' + seconds;\n        if (hours !== 0) res = hours + ':' + res;\n\n        if (negative) res = '-' + res;\n\n        return res;\n    };\n});\n'use strict';\n\nangular.module('RouteExplorer').factory('Layout', ['$http', '$q', 'TimeParser', function ($http, $q, TimeParser) {\n    var self = this;\n    var stops = [];\n    var stopsMap = {};\n    var routes = [];\n    var routesMap = {};\n\n    var loadedPromise = $q.all([$http.get('/api/v1/stops/').then(function (response) {\n        stops = response.data.map(function (s) {\n            return {\n                id: s.stop_id,\n                name: s.heb_stop_names[0],\n                names: s.heb_stop_names,\n                latlon: s.latlon\n            };\n        });\n        stops.forEach(function (s) {\n            stopsMap[s.id] = s;\n        });\n    }), $http.get('/api/v1/routes/all/').then(function (response) {\n        routes = response.data.map(function (r) {\n            return {\n                id: r.id,\n                stops: r.stop_ids,\n                count: r.count,\n                minDate: new Date(r.min_date),\n                maxDate: new Date(r.max_date)\n            };\n        });\n\n        routesMap = routes.reduce(function (m, r) {\n            m[r.id] = r;return m;\n        }, {});\n    })]);\n\n    var findStop = function findStop(stopId) {\n        return stopsMap[stopId] || null;\n    };\n\n    var findStopName = function findStopName(stopId) {\n        return findStop(stopId).name;\n    };\n\n    var _findRoutes = function _findRoutes(routes, originId, destinationId) {\n        var matchingRoutes = {};\n\n        routes.forEach(function (r) {\n            var originIndex = r.stops.indexOf(originId);\n            var destinationIndex = r.stops.indexOf(destinationId);\n\n            if (originIndex < 0 || destinationIndex < 0) return;\n\n            if (originIndex > destinationIndex) return;\n\n            var routeStops = r.stops;\n            var routeId = r.id;\n\n            if (routeId in matchingRoutes) matchingRoutes[routeId].count += r.count;else {\n                matchingRoutes[routeId] = {\n                    id: routeId,\n                    stops: routeStops,\n                    count: r.count\n                };\n            }\n        });\n\n        matchingRoutes = Object.keys(matchingRoutes).map(function (routeId) {\n            return matchingRoutes[routeId];\n        });\n        matchingRoutes.sort(function (r1, r2) {\n            return r2.count - r1.count;\n        });\n        return matchingRoutes;\n    };\n\n    var findRoutesByPeriod = function findRoutesByPeriod(origin, destination, from, to) {\n        // TODO use minDate and maxDate from our cached routes to avoid the http request\n\n        var d = $q.defer();\n        var matchingRoutes = _findRoutes(routes, origin, destination);\n        if (matchingRoutes.length === 0) {\n            d.resolve([]);\n        } else {\n            var fromDate = from;\n            var toDate = to;\n\n            $http.get('/api/v1/routes/all-by-date/', {\n                params: {\n                    from_date: TimeParser.createRequestString(fromDate),\n                    to_date: TimeParser.createRequestString(toDate)\n                }\n            }).then(function (response) {\n                var routesInDate = response.data.map(function (r) {\n                    return {\n                        id: r.id,\n                        stops: r.stop_ids,\n                        count: r.count\n                    };\n                });\n                d.resolve(_findRoutes(routesInDate, origin, destination));\n            }, function (response) {\n                d.reject({ 'msg': 'Error fetching routes', 'response': response });\n            });\n        }\n\n        return d.promise;\n    };\n\n    var findRoute = function findRoute(routeId) {\n        return routesMap[routeId] || null;\n    };\n\n    var getRoutesDateRange = function getRoutesDateRange() {\n        var max = new Date(1900, 0, 1);\n        var min = new Date(2100, 0, 1);\n\n        for (var i in routes) {\n            var route = routes[i];\n            if (route.count === 0) continue;\n\n            if (route.minDate && route.minDate < min) min = route.minDate;\n            if (route.maxDate && route.maxDate > max) max = route.maxDate;\n        }\n        return {\n            min: min,\n            max: max\n        };\n    };\n\n    var service = {\n        getStops: function getStops() {\n            return stops;\n        },\n        getRoutes: function getRoutes() {\n            return routes;\n        },\n        findRoute: findRoute,\n        findStop: findStop,\n        findStopName: findStopName,\n        findRoutes: function findRoutes(origin, destination) {\n            return _findRoutes(routes, origin, destination);\n        },\n        findRoutesByPeriod: findRoutesByPeriod,\n        getRoutesDateRange: getRoutesDateRange\n    };\n\n    return loadedPromise.then(function () {\n        return service;\n    });\n}]);\n'use strict';\n\nangular.module('RouteExplorer').constant('Locale', {\n    months: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'].map(function (v, i) {\n        return { id: i + 1, name: v };\n    }),\n\n    days: [{ abbr: 'א', name: 'ראשון', id: 1 }, { abbr: 'ב', name: 'שני', id: 2 }, { abbr: 'ג', name: 'שלישי', id: 3 }, { abbr: 'ד', name: 'רביעי', id: 4 }, { abbr: 'ה', name: 'חמישי', id: 5 }, { abbr: 'ו', name: 'שישי', id: 6 }, { abbr: 'ש', name: 'שבת', id: 7 }],\n    until: 'עד ל'\n});\n'use strict';\n\nangular.module('RouteExplorer').factory('LocationBinder', ['$location', function ($location) {\n    return {\n        bind: function bind(scope, scopeProperty, locationProperty, parser, formatter) {\n            scope[scopeProperty] = $location.search()[locationProperty] || null;\n\n            scope.$watch(scopeProperty, function (value) {\n                if (formatter) value = formatter(value);\n\n                $location.search(locationProperty, value);\n            });\n\n            scope.$watch(function () {\n                return $location.search()[locationProperty] || null;\n            }, function (value) {\n                if (parser) value = parser(value);\n\n                scope[scopeProperty] = value;\n            });\n        }\n    };\n}]);\n'use strict';\n\nangular.module('RouteExplorer').factory('TimeParser', [function () {\n    function createRequestString(date, sep) {\n        sep = sep || '/';\n        var dd = date.getDate().toString();\n        var mm = (date.getMonth() + 1).toString();\n        var yyyy = date.getFullYear().toString();\n        return dd + sep + mm + sep + yyyy;\n    }\n\n    function parseMonth(monthString) {\n        var year = Number(monthString.substr(0, 4));\n        var month = Number(monthString.substr(4, 2));\n        return new Date(year, month - 1, 1);\n    }\n\n    function parsePeriod(periodString) {\n        var parts = periodString.split('-', 2);\n        var from = parseMonth(parts[0]);\n        var to = parts.length > 1 ? parseMonth(parts[1]) : from;\n        var end = new Date(to.getFullYear(), to.getMonth() + 1, 1);\n        return { from: from, to: to, end: end };\n    }\n\n    function formatMonth(date) {\n        return date.getFullYear() + ('0' + (date.getMonth() + 1)).slice(-2);\n    }\n\n    function formatPeriod(period) {\n        var f = formatMonth(period.from);\n        if (period.from < period.to) f += '-' + formatMonth(period.to);\n\n        return f;\n    }\n\n    return {\n        createRequestString: createRequestString,\n        parseMonth: parseMonth,\n        parsePeriod: parsePeriod,\n        formatMonth: formatMonth,\n        formatPeriod: formatPeriod\n    };\n}]);","angular.module('RouteExplorer').controller('HeatMapController',\n    function ($scope, $http, Layout) {\n        \"ngInject\";\n        $scope.Layout = Layout;\n        var ta = $scope.Layout.findStop(4600); // TA HASHALOM\n        console.log(ta);\n        angular.extend($scope, {\n            defaults: {\n                scrollWheelZoom: false\n            },\n            center: {\n                lat: ta.latlon[0],\n                lng: ta.latlon[1],\n                zoom: 10,\n            }\n        });\n        $scope.stops = Layout.getStops();\n        $scope.input = {\n            stop: $scope.stops[0]\n        }\n        $scope.paths = [];\n        $http.get('/api/v1/heat-map/').then(function (resp) {\n            $scope.heatmapData = resp.data;\n            //var maxScore = 0;\n            //var minScore = 1;\n\n            //$scope.heatmapData.forEach(function(score) {\n            //    maxScore = Math.max(score.score, maxScore);\n            //    minScore = Math.min(score.score, minScore);\n            //});\n\n            $scope.heatmapData.forEach(function (score) {\n                var latlng = $scope.Layout.findStop(score.stop_id).latlon;\n                var g = 255-Math.floor(255 * score.score);\n                var color = 'rgb(255,' + g + ',0)';\n                var message = $scope.Layout.findStop(score.stop_id).name + '<br/>' + Math.floor(score.score * 100) / 100;\n                $scope.paths.push({\n                    color: color,\n                    fillColor: color,\n                    fillOpacity: 1,\n                    type: \"circleMarker\",\n                    stroke: false,\n                    radius: 10,\n                    latlngs: latlng,\n                    message: message,\n                    popupOptions: {\n                        className: 'ot-popup'\n                    }\n                });\n            });\n        });\n\n    });\n\n\n","'use strict';\n\nangular.module('RouteExplorer').controller('HighlightsController',\n        function ($scope,\n                  $http,\n                  $q,\n                  $timeout,\n                  $location,\n                  Layout,\n                  daysTable,\n                  hoursList,\n                  monthNames) {\n            'ngInject';\n            $scope.init = () => {\n                $http.get(\"/api/v1/highlights/\").then(resp => {\n                    $scope.highlights = resp.data.highlights;\n                    $scope.url = resp.data.url;\n                    $scope.fields = [\n                        {\n                            name: 'תאריך',\n                            sortKey: v => {\n                                return v.year * 100 +  v.month;\n                            }\n                        },\n                        {\n                            name: 'מספר נסיעות',\n                            sortKey: v => {\n                                return v.num_trips;\n                            },\n                            initialDesc: true,\n                        },\n                        {\n                            name: 'יום בשבוע',\n                            sortKey: v => {\n                                if (v.week_day == 'all') {\n                                    return -1;\n                                }\n                                return v.week_day;\n                            }\n                        },\n                        {\n                            name: 'שעות',\n                            sortKey: v => {\n                                if (v.hours == 'all') {\n                                    return -1;\n                                }\n                                return v.hours[1];\n                            }\n                        },\n                        {\n                            name: '% איחורים מעל 5 דקות',\n                            active: true,\n                            asc: false,\n                            initialDesc: true,\n                            sortKey: v => {\n                                return v.mean_arrival_late_pct;\n                            }\n                        },\n                        {\n                            name: 'קישור',\n                            disableSort: true,\n                        }\n                    ];\n                    $scope.refresh();\n                });\n\n            };\n            $scope.sortBy = function(activeField) {\n                for (let f of $scope.fields) {\n                    if (f != activeField) {\n                        f.active = false;\n                    }\n                }\n                if (activeField.active) {\n                    activeField.asc = !activeField.asc;\n                } else {\n                    activeField.active = true;\n                    activeField.asc = !activeField.initialDesc;\n                }\n                $scope.refresh();\n            };\n            $scope.refresh = function() {\n                let activeField = null;\n                for (let f of $scope.fields) {\n                    if (f.active) {\n                        activeField = f;\n                    }\n                }\n                if (!activeField) {\n                    return;\n                }\n                $scope.highlights.sort((v1, v2) => {\n                    let k1 = activeField.sortKey(v1);\n                    let k2 = activeField.sortKey(v2);\n                    let asc = activeField.asc ? 1 : -1;\n                    if (k1 > k2) {\n                        return 1*asc;\n                    }\n                    if (k1 < k2) {\n                        return -1*asc;\n                    }\n                    return 0;\n                });\n            };\n            $scope.init();\n        });\n\n\n\n\n\n\n","angular.module('RouteExplorer').controller('RouteDetailsController',\nfunction($scope, $route, $http, $location, LocationBinder, Layout, Locale, TimeParser) {\n    \"ngInject\";\n    var routeParams = $route.current.params;\n\n    var period = TimeParser.parsePeriod(routeParams.period);\n    var startDate = TimeParser.createRequestString(period.from);\n    var endDate = TimeParser.createRequestString(period.end);\n\n    var routeId = routeParams.routeId;\n    var stopIds = Layout.findRoute(routeId).stops;\n    var statsMap = {};\n\n    $scope.loaded = false;\n    $scope.stopIds = stopIds;\n    $scope.origin = stopIds[0];\n    $scope.destination = stopIds[stopIds.length - 1];\n\n    $scope.selectedPeriod = formatMonth(period.from);\n    if (period.to > period.from) {\n        $scope.selectedPeriod += \" \\u2014 \" + formatMonth(period.to)\n    }\n\n    $scope.selectedDay = null;\n    $scope.days = Locale.days;\n\n    $scope.selectedTime = null;\n    $scope.times = [];\n\n    $scope.selectRouteUrl = '#/' + routeParams.period + '/select-route/' + $scope.origin + '/' + $scope.destination;\n\n    var previousPeriod = offsetPeriod(period, -1);\n    var nextPeriod = offsetPeriod(period, +1);\n    var bounds = Layout.getRoutesDateRange();\n    var day = 10 * 24 * 60 * 60 * 1000;\n    $scope.previousPeriodUrl = bounds.min.getTime() - day < previousPeriod.from.getTime() ? '#/' + TimeParser.formatPeriod(previousPeriod) + '/routes/' + routeId : null;\n    $scope.nextPeriodUrl = bounds.max > nextPeriod.to ? '#/' + TimeParser.formatPeriod(nextPeriod) + '/routes/' + routeId : null;\n\n    $http.get('/api/v1/stats/route-info-full', { params: { route_id: routeId, from_date: startDate, to_date: endDate } })\n        .success(function(data) {\n            loadStats(data);\n            $scope.loaded = true;\n        });\n\n    LocationBinder.bind($scope, 'selectedDay', 'day', function(val) { return val ? Number(val) : null; });\n    LocationBinder.bind($scope, 'selectedTime', 'time');\n\n    $scope.stopStats = function(stopId) {\n        var stats = selectedStats();\n        for (var i in stats) {\n            if (stats[i].stop_id == stopId)\n                return stats[i];\n        }\n        return null;\n    };\n\n    $scope.stopName = function(stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop)\n            return null;\n\n            return stop.name;\n    };\n\n    $scope.isDayEmpty = function(day) {\n        var dayId = day.id;\n        var dayTimes = statsMap[dayId];\n\n        if (!dayTimes)\n            return true;\n\n        for (var time in dayTimes)\n            if (dayTimes[time].info.num_trips > 0)\n                return false;\n\n        return true;\n    };\n\n    $scope.isTimeEmpty = function(time) {\n        var dayId = $scope.selectedDay || 'all';\n        var timeId = time.id;\n\n        var timeStats = statsMap[dayId] && statsMap[dayId][timeId];\n        if (timeStats && timeStats.info.num_trips > 0)\n            return false;\n\n        return true;\n    };\n\n    $scope.tripCount = function(dayId, timeId) {\n      var stats = getStats(dayId, timeId);\n      if (!stats)\n        return 0;\n\n      return stats.info.num_trips;\n    };\n\n    function getStats(dayId, timeId) {\n      dayId = dayId || 'all';\n      timeId = timeId || 'all';\n      return statsMap[dayId] && statsMap[dayId][timeId] ? statsMap[dayId][timeId] : null;\n    }\n\n    function selectedStats() {\n        var stats = getStats($scope.selectedDay, $scope.selectedTime);\n        if (stats)\n          return stats.stops;\n\n        return [];\n    }\n\n    function loadStats(data) {\n        $scope.times = [];\n        var timesMap = {};\n\n        for (var i in data) {\n            var statGroup = data[i];\n            var timeId = statGroup.info.hours == 'all' ? 'all' : statGroup.info.hours[0] + '-' + statGroup.info.hours[1];\n            var dayId = statGroup.info.week_day;\n\n            if (!statsMap[dayId])\n                statsMap[dayId] = {};\n\n            statsMap[dayId][timeId] = statGroup;\n\n            if (timeId != 'all' && !timesMap[timeId]) {\n                var time = {\n                    id: timeId,\n                    from: formatHour(statGroup.info.hours[0]),\n                    to: formatHour(statGroup.info.hours[1])\n                };\n                timesMap[timeId] = time;\n                $scope.times.push(time);\n            }\n        }\n    }\n\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear()\n    }\n\n    function offsetMonth(date, offset) {\n        var d = new Date(date);\n        d.setMonth(d.getMonth() + offset);\n        return d;\n    }\n\n    function offsetPeriod(period, offset) {\n        var size =\n            (period.to.getFullYear() - period.from.getFullYear()) * 12 +\n            period.to.getMonth() - period.from.getMonth() + 1;\n\n        return {\n            from: offsetMonth(period.from, size * offset),\n            to: offsetMonth(period.to, size * offset),\n            end: offsetMonth(period.end, size * offset)\n        };\n    }\n});\n","'use strict';\n\nangular.module('RouteExplorer').controller('RealRoutesController',\n        function ($scope,\n                  $http,\n                  $q,\n                  $timeout,\n                  $location,\n                  Layout,\n                  daysTable,\n                  hoursList,\n                  monthNames) {\n            'ngInject';\n            $scope.selectedYear = 2017;\n            $scope.selectedMonth = 9;\n            $scope.getMonths = () => {\n                return [1,2,3,4,5,6,7,8,9,10,11,12];\n            };\n            $scope.getYears = () => {\n                let result = [];\n                let lastYear = new Date().getFullYear();\n                let y = 2015;\n                while (y <= lastYear) {\n                    result.push(y);\n                    y++;\n                }\n                return result;\n            };\n            $scope.init = () => {\n                $scope.months = $scope.getMonths();\n                $scope.years = $scope.getYears();\n            };\n            $scope.refresh = () => {\n                $scope.realRoutes = null;\n                let y = $scope.selectedYear;\n                let m = $scope.selectedMonth;\n                $http.get(`/api/v1/real-routes/${y}/${m}/`).then(resp => {\n                    $scope.realRoutes = resp.data;\n                    for (let rr of $scope.realRoutes) {\n                        console.log(rr);\n                        rr.firstStop = rr.stops[0];\n                        rr.lastStop = rr.stops[rr.stops.length-1];\n                    }\n                });\n            }\n            $scope.init();\n        });\n\n\n\n\n\n\n","angular.module('RouteExplorer').controller('SelectRouteController',\nfunction($scope, $http, $location, $route, Layout, TimeParser) {\n    'ngInject';\n    $scope.stops = Layout.getStops();\n    var period = TimeParser.parsePeriod($route.current.params.period);\n    var origin = Layout.findStop($route.current.params.origin);\n    var destination = Layout.findStop($route.current.params.destination);\n\n    var graphsUrlParams = [\n        'startStop=' + origin.id,\n        'endStop=' + destination.id,\n        'startDate='+TimeParser.createRequestString(period.from,'-'),\n        'endDate='+TimeParser.createRequestString(period.end,'-'),\n    ];\n    $scope.graphsUrl = \"#/graphs?\" + graphsUrlParams.join(\"&\");\n\n    $http.get('/api/v1/stats/path-info-full/', { params: {\n        origin: origin.id,\n        destination: destination.id,\n        from_date: TimeParser.createRequestString(period.from),\n        to_date: TimeParser.createRequestString(period.end) }\n    }).success(function(data) {\n            loadStats(data);\n            $scope.loaded = true;\n    });\n\n    var statsMap = {};\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear()\n    }\n\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n\n    function loadStats(data) {\n        $scope.stats = data;\n    }\n\n    Layout.findRoutesByPeriod(origin.id, destination.id, period.from, period.end).then(function(routes) {\n        $scope.routes = routes;\n    });\n\n    function stopName(stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop)\n            return null;\n\n        return stop.name;\n    }\n\n    $scope.isOrigin = function(stopId) {\n        return stopId == origin.id;\n    };\n\n    $scope.isDestination = function(stopId) {\n        return stopId == destination.id;\n    };\n\n    $scope.stopText = function(stopId) {\n        return stopName(stopId);\n    };\n\n\n    $scope.barWidth = function(route) {\n        var percentWidth = route.count * 100.0 / $scope.routes[0].count;\n\n        if (percentWidth < 1.0)\n            return \"1px\";\n\n        return percentWidth + \"%\";\n    };\n\n    $scope.routeUrl = function(route) {\n        return '/#/' + $route.current.params.period + '/routes/' + route.id;\n    };\n\n});\n","angular.module('RouteExplorer').controller('SelectStopsController',\n['$scope', '$rootScope', '$location', 'Layout', 'Locale', 'TimeParser',\nfunction($scope, $rootScope, $location, Layout, Locale, TimeParser) {\n    'ngInject';\n    $scope.stops = Layout.getStops();\n    $scope.origin = null;\n    $scope.destination = null;\n    $scope.months = Locale.months;\n\n    var dateRange = Layout.getRoutesDateRange();\n    $scope.periods = generatePeriods(dateRange.min, dateRange.max);\n    $scope.startPeriod = $scope.periods[0];\n    $scope.endPeriod = $scope.periods[0];\n\n    $scope.formValid = function() {\n        return (\n            !!$scope.origin &&\n            !!$scope.destination &&\n            $scope.origin != $scope.destination &&\n            $scope.startPeriod.from <= $scope.endPeriod.to\n        );\n    };\n\n    $scope.stopName = function(stopId) {\n        var stop = Layout.findStop(stopId);\n        if (!stop)\n            return null;\n\n        return stop.name;\n    };\n\n    $scope.goToRoutes = function() {\n        $scope.noRoutes = false;\n        $scope.loading = true;\n        var period = {\n            from: $scope.startPeriod.from,\n            to: $scope.endPeriod.to,\n            end: $scope.endPeriod.end,\n        };\n        var fromDate = period.from;\n        var toDate = period.end;\n        var periodStr = TimeParser.formatPeriod(period);\n        Layout.findRoutesByPeriod($scope.origin.id, $scope.destination.id, fromDate, toDate)\n            .then(function(routes) {\n                if (routes.length === 0) {\n                    $scope.noRoutes = true;\n                } else if (routes.length == 1) {\n                    $location.path('/' + periodStr + '/routes/' + routes[0].id);\n                } else {\n                    $location.path('/' + periodStr + '/select-route/' + $scope.origin.id + '/' + $scope.destination.id);\n                }\n            })\n            .finally(function() {\n                $scope.loading = false;\n            });\n    };\n\n    $scope.dismissError = function() {\n        $scope.noRoutes = false;\n    };\n\n    function generatePeriods(fromDate, toDate) {\n      // fromDate=1970-1-1 due to a data bug. This is a quick temporary workaround\n      if (fromDate.getFullYear() < 2013) fromDate = new Date(2013, 0, 1);\n\n      var periods = [];\n      var start = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);\n      while (start < toDate) {\n        let end = new Date(start.getFullYear(), start.getMonth() + 1, start.getDate());\n        var period = {\n          from: start,\n          to: start,\n          end: end,\n          name: Locale.months[start.getMonth()].name + \" \" + start.getFullYear()\n        };\n        period.toName = Locale.until + period.name;\n        periods.push(period);\n        start = end;\n      }\n      periods.reverse();\n      return periods;\n    }\n}]);\n","angular.module('RouteExplorer').controller('TimesDetailsController',\nfunction($scope, $route, Locale, LocationBinder, Layout) {\n    'ngInject';\n    Layout.then(function(Layout) {\n        $scope.layout = Layout;\n    });\n    $scope.layout = null;\n\n    var statsMap = {};\n    var routeParams = $route.current.params;\n    $scope.stopIds = [parseInt(routeParams.origin), parseInt(routeParams.destination)];\n    LocationBinder.bind($scope, 'selectedDay', 'day', function(val) { return val ? Number(val) : null; });\n    LocationBinder.bind($scope, 'selectedTime', 'time');\n    function formatHour(hour) {\n        return ('0' + hour % 24 + '').slice(-2) + ':00';\n    }\n\n    function formatMonth(date) {\n        return Locale.months[date.getMonth()].name + ' ' + date.getFullYear()\n    }\n\n    function selectedStats() {\n        var stats = getStats($scope.selectedDay, $scope.selectedTime);\n        if (stats)\n          return stats.stops;\n\n        return [];\n    }\n\n    $scope.stopName = function(stopId) {\n        if ($scope.layout) {\n            var stop = $scope.layout.findStop(stopId);\n            if (!stop)\n                return null;\n\n            return stop.name;\n        } else {\n            return null;\n        }\n    };\n\n    $scope.selectedDay = null;\n    $scope.days = Locale.days;\n\n    $scope.selectedTime = null;\n    $scope.times = [];\n\n    $scope.loadStats = function() {\n        var data = $scope.stats;\n        $scope.times = [];\n        var timesMap = {};\n\n        for (var i in data) {\n            var statGroup = data[i];\n            var timeId = statGroup.info.hours == 'all' ? 'all' : statGroup.info.hours[0] + '-' + statGroup.info.hours[1];\n            var dayId = statGroup.info.week_day;\n\n            if (!statsMap[dayId])\n                statsMap[dayId] = {};\n\n            statsMap[dayId][timeId] = statGroup;\n\n            if (timeId != 'all' && !timesMap[timeId]) {\n                var time = {\n                    id: timeId,\n                    from: formatHour(statGroup.info.hours[0]),\n                    to: formatHour(statGroup.info.hours[1])\n                };\n                timesMap[timeId] = time;\n                $scope.times.push(time);\n            }\n        }\n    };\n    $scope.tripCount = function(dayId, timeId) {\n      var stats = getStats(dayId, timeId);\n      if (!stats)\n        return 0;\n\n      return stats.info.num_trips;\n    };\n\n    function getStats(dayId, timeId) {\n      dayId = dayId || 'all';\n      timeId = timeId || 'all';\n      return statsMap[dayId] && statsMap[dayId][timeId] ? statsMap[dayId][timeId] : null;\n    }\n\n    $scope.isTimeEmpty = function(time) {\n        var dayId = $scope.selectedDay || 'all';\n        var timeId = time.id;\n\n        var timeStats = statsMap[dayId] && statsMap[dayId][timeId];\n        if (timeStats && timeStats.info.num_trips > 0)\n            return false;\n\n        return true;\n    };\n\n    $scope.stopStats = function(stopId) {\n        var stats = selectedStats();\n        for (var i in stats) {\n            if (stats[i].stop_id == stopId)\n                return stats[i];\n        }\n        return null;\n    };\n\n    $scope.loadStats();\n});\n\n","'use strict';\n\nangular.module('RouteExplorer').controller('TopHighlightsController',\n        function ($scope,\n                  $http,\n                  $q,\n                  $timeout,\n                  $location,\n                  Layout,\n                  daysTable,\n                  hoursList,\n                  monthNames) {\n            'ngInject';\n            $scope.init = () => {\n                $http.get(\"/api/v1/highlights/top/\").then(resp => {\n                    let data = resp.data.highlights;\n                    $scope.highlightLists =  [\n                        {\n                            'kind': 'late',\n                            'title': 'נסיעה באיחור',\n                            'items': data.late,\n                            'color': 'danger',\n                        },\n                        {\n                            'kind': 'ontime',\n                            'title': 'נסיעה בזמן',\n                            'items': data.ontime,\n                            'color': 'success',\n                        }\n                    ];\n                });\n            };\n            $scope.init();\n        });\n\n\n\n\n\n\n","'use strict';\nangular.module('RouteExplorer').controller('TripDetailsController',\n        function ($scope,\n                  $http,\n                  $q,\n                  $timeout,\n                  $location,\n                  Layout,\n                  ) {\n            'ngInject';\n            $scope.isLegalTripId = () => {\n                let n = $scope.tripId;\n                return !isNaN(parseInt(n)) && !isNaN(n - 0)\n            };\n            $scope.x_fields =[\n                \"x_week_day_local\",\n                \"x_hour_local\",\n                \"x_max_delay_arrival\",\n                \"x_max2_delay_arrival\",\n                \"x_avg_delay_arrival\",\n                \"x_last_delay_arrival\",\n                \"x_before_last_delay_arrival\"\n            ]\n\n            $scope.refreshTrip = () => {\n                $location.search({\n                    'trip_id': $scope.tripId\n                })\n                $scope.wip = true;\n                $scope.getError = false;\n                $scope.trip = null;\n                $http.get(`/api/v1/trips/${$scope.tripId}/`).then(resp=> {\n                    $scope.trip = resp.data;\n                    $scope.wip = false;\n                }, resp => {\n                    $scope.wip = false;\n                    $scope.getError = true;\n                })\n            }\n            $scope.tripId = 343440;\n            $scope.refreshTrip();\n        });\n\n\n\n\n\n\n","angular.module('RouteExplorer').directive(\"rexPercentBar\",\n['env',\nfunction(env) {\n    return {\n        restrict: 'E',\n        scope: {\n          value: '=value',\n          type: '=type'\n        },\n        templateUrl: env.baseDir + '/tpls/PercentBar.html'\n      };\n}]);\n","angular.module('RouteExplorer').directive(\"timesDetails\",\n['env','Layout',\nfunction(env, Layout) {\n    return {\n        restrict: 'E',\n        scope: {\n            stats: '='\n        },\n        controller: 'TimesDetailsController',\n        templateUrl: env.baseDir + '/tpls/TimesDetails.html'\n      };\n}]);\n","let daysTable = {\n            0: 'ראשון',\n            1: 'שני',\n            2: 'שלישי',\n            3: 'רביעי',\n            4: 'חמישי',\n            5: 'שישי',\n            6: 'שבת',\n        };\n\nangular.module('RouteExplorer')\n    .filter('week_day1', function () {\n        return function (day) {\n            if (day == 'all') {\n                return 'כל הימים';\n            }\n            return daysTable[day-1] || `??? ${day}`;\n        }\n    }).filter('week_day0', function () {\n        return function (day) {\n            if (day == 'all') {\n                return 'כל הימים';\n            }\n            return daysTable[day] || `??? ${day}`;\n        }\n    }).filter('hours', function () {\n        return function(hours) {\n            let fix = h => h >= 24 ? h % 24 : h;\n            if (hours == 'all') {\n                return 'כל היום'\n            }\n            let h1 = fix(hours[1]);\n            let h0 = fix(hours[0]);\n            return `${h1} - ${h0}`;\n        }\n    }).filter('month_name', function() {\n        let months = [\n          'ינואר',\n          'פברואר',\n          'מרץ',\n          'אפריל',\n          'מאי',\n          'יוני',\n          'יולי',\n          'אוגוסט',\n          'ספטמבר',\n          'אוקטובר',\n          'נובמבר',\n          'דצמבר'\n        ]\n        return function(m) {\n            return months[m-1];\n        }\n    });\n\n\n","angular.module('RouteExplorer').filter('duration', function() {\n    return function(seconds) {\n        var negative = false;\n        seconds = Math.trunc(seconds);\n        if (seconds < 0) {\n            negative = true;\n            seconds = -seconds;\n        }\n\n        var minutes = Math.trunc(seconds / 60);\n        seconds -= minutes * 60;\n        var hours = Math.trunc(minutes / 60);\n        minutes -= hours * 60;\n\n        if (seconds < 10) seconds = '0' + seconds;\n        if (minutes < 10 && hours !== 0) minutes = '0' + minutes;\n\n        var res = minutes + ':' + seconds;\n        if (hours !== 0)\n            res = hours + ':' + res;\n\n        if (negative)\n            res = '-' + res;\n\n        return res;\n    };\n});\n","angular.module('RouteExplorer').factory('Layout',\n['$http', '$q', 'TimeParser',\nfunction($http, $q, TimeParser) {\n    var self = this;\n    var stops = [];\n    var stopsMap = {};\n    var routes = [];\n    var routesMap = {};\n\n    var loadedPromise = $q.all([\n        $http.get('/api/v1/stops/')\n            .then(function(response) {\n                stops = response.data.map(function(s) { return {\n                    id: s.stop_id,\n                    name: s.heb_stop_names[0],\n                    names: s.heb_stop_names,\n                    latlon: s.latlon,\n                }; });\n                stops.forEach(function(s) { stopsMap[s.id] = s; });\n            }),\n\n        $http.get('/api/v1/routes/all/')\n            .then(function(response) {\n                routes = response.data.map(function(r) { return {\n                    id: r.id,\n                    stops: r.stop_ids,\n                    count: r.count,\n                    minDate: new Date(r.min_date),\n                    maxDate: new Date(r.max_date)\n                }; });\n\n                routesMap = routes.reduce(function(m, r) { m[r.id] = r; return m; }, {});\n            })\n    ]);\n\n    var findStop = function(stopId) {\n        return stopsMap[stopId] || null;\n    };\n\n    var findStopName = function(stopId) {\n        return findStop(stopId).name;\n    };\n\n    var findRoutes = function(routes, originId, destinationId) {\n        var matchingRoutes = {};\n\n        routes.forEach(function(r) {\n            var originIndex = r.stops.indexOf(originId);\n            var destinationIndex = r.stops.indexOf(destinationId);\n\n            if (originIndex < 0 || destinationIndex < 0)\n                return;\n\n            if (originIndex > destinationIndex)\n                return;\n\n            var routeStops = r.stops;\n            var routeId = r.id;\n\n            if (routeId in matchingRoutes)\n                matchingRoutes[routeId].count += r.count;\n            else {\n                matchingRoutes[routeId] = {\n                    id: routeId,\n                    stops: routeStops,\n                    count: r.count\n                };\n            }\n        });\n\n        matchingRoutes = Object.keys(matchingRoutes).map(function(routeId) { return matchingRoutes[routeId]; });\n        matchingRoutes.sort(function(r1, r2) { return r2.count - r1.count; });\n        return matchingRoutes;\n    };\n\n    var findRoutesByPeriod = function(origin, destination, from, to) {\n        // TODO use minDate and maxDate from our cached routes to avoid the http request\n\n        var d = $q.defer();\n        var matchingRoutes = findRoutes(routes, origin, destination);\n        if (matchingRoutes.length === 0) {\n            d.resolve([]);\n        } else {\n            var fromDate = from;\n            var toDate = to;\n\n            $http.get('/api/v1/routes/all-by-date/', {\n                params: {\n                    from_date: TimeParser.createRequestString(fromDate),\n                    to_date: TimeParser.createRequestString(toDate)\n                }\n            }).then(function(response) {\n                var routesInDate = response.data.map(function(r) {\n                    return {\n                        id: r.id,\n                        stops: r.stop_ids,\n                        count: r.count\n                    };\n                });\n                d.resolve(findRoutes(routesInDate, origin, destination));\n            }, function(response) { d.reject({ 'msg': 'Error fetching routes', 'response': response }); });\n        }\n\n        return d.promise;\n    };\n\n    var findRoute = function(routeId) {\n        return routesMap[routeId] || null;\n    };\n\n    var getRoutesDateRange = function() {\n        var max = new Date(1900, 0, 1);\n        var min = new Date(2100, 0, 1);\n\n        for (var i in routes) {\n            var route = routes[i];\n            if (route.count === 0)\n              continue;\n\n            if (route.minDate && route.minDate < min) min = route.minDate;\n            if (route.maxDate && route.maxDate > max) max = route.maxDate;\n        }\n        return {\n          min: min,\n          max: max\n        };\n    };\n\n    let service = {\n        getStops: function() { return stops; },\n        getRoutes: function() { return routes; },\n        findRoute: findRoute,\n        findStop: findStop,\n        findStopName: findStopName,\n        findRoutes: function(origin, destination) { return findRoutes(routes, origin, destination); },\n        findRoutesByPeriod: findRoutesByPeriod,\n        getRoutesDateRange: getRoutesDateRange\n    };\n\n    return loadedPromise.then(function() { return service; });\n}]);\n","angular.module('RouteExplorer').constant('Locale', {\n  months: [\n      'ינואר',\n      'פברואר',\n      'מרץ',\n      'אפריל',\n      'מאי',\n      'יוני',\n      'יולי',\n      'אוגוסט',\n      'ספטמבר',\n      'אוקטובר',\n      'נובמבר',\n      'דצמבר'\n  ].map(function(v, i) { return { id: i + 1, name: v }; }),\n\n  days: [\n      { abbr: 'א', name: 'ראשון', id: 1 },\n      { abbr: 'ב', name: 'שני', id: 2 },\n      { abbr: 'ג', name: 'שלישי', id: 3 },\n      { abbr: 'ד', name: 'רביעי', id: 4 },\n      { abbr: 'ה', name: 'חמישי', id: 5 },\n      { abbr: 'ו', name: 'שישי', id: 6 },\n      { abbr: 'ש', name: 'שבת', id: 7 }\n  ],\n  until: 'עד ל'\n});\n","angular.module('RouteExplorer').factory('LocationBinder',\n['$location',\nfunction($location) {\n    return {\n        bind: function(scope, scopeProperty, locationProperty, parser, formatter) {\n            scope[scopeProperty] = $location.search()[locationProperty] || null;\n\n            scope.$watch(scopeProperty, function(value) {\n                if (formatter)\n                    value = formatter(value);\n\n                $location.search(locationProperty, value);\n            });\n\n            scope.$watch(function() { return $location.search()[locationProperty] || null; }, function(value) {\n                if (parser)\n                    value = parser(value);\n\n                scope[scopeProperty] = value;\n            });\n        }\n    };\n}]);\n","angular.module('RouteExplorer').factory('TimeParser',\n[\nfunction() {\n    function createRequestString(date, sep) {\n        sep = sep || '/';\n        var dd = date.getDate().toString();\n        var mm = (date.getMonth()+1).toString();\n        var yyyy = date.getFullYear().toString();\n        return dd + sep + mm + sep + yyyy;\n    }\n\n    function parseMonth(monthString) {\n        var year = Number(monthString.substr(0, 4));\n        var month = Number(monthString.substr(4, 2));\n        return new Date(year, month - 1, 1);\n    }\n\n    function parsePeriod(periodString) {\n        var parts = periodString.split('-', 2);\n        var from = parseMonth(parts[0]);\n        var to = parts.length > 1 ? parseMonth(parts[1]) : from;\n        var end = new Date(to.getFullYear(), to.getMonth() + 1, 1);\n        return { from: from, to: to, end: end };\n    }\n\n    function formatMonth(date) {\n        return date.getFullYear() + ('0' + (date.getMonth() + 1)).slice(-2);\n    }\n\n    function formatPeriod(period) {\n        var f = formatMonth(period.from);\n        if (period.from < period.to)\n            f += '-' + formatMonth(period.to);\n\n        return f;\n    }\n\n    return {\n        createRequestString: createRequestString,\n        parseMonth: parseMonth,\n        parsePeriod: parsePeriod,\n        formatMonth: formatMonth,\n        formatPeriod: formatPeriod\n    }\n}]);\n"]}