String.prototype.repeat||(String.prototype.repeat=function(t){"use strict";if(null===this)throw new TypeError("can't convert "+this+" to object");var n=""+this;if(t=+t,t!=t&&(t=0),0>t)throw new RangeError("repeat count must be non-negative");if(t==1/0)throw new RangeError("repeat count must be less than infinity");if(t=Math.floor(t),0===n.length||0===t)return"";if(n.length*t>=1<<28)throw new RangeError("repeat count must not overflow maximum string size");for(var e="";1==(1&t)&&(e+=n),t>>>=1,0!==t;)n+=n;return e}),function(){var t=angular.module("RouteExplorer",["ngRoute","ui.bootstrap","ui.bootstrap.buttons"]);t.constant("env",{baseDir:"/static/ui/RouteExplorer"}),t.config(["$routeProvider","env",function(t,n){var e=function(t){return n.baseDir+"/tpls/"+t+".html"};t.when("/",{pageId:"welcome",templateUrl:e("SelectStops"),controller:"SelectStopsController",resolve:{Layout:"Layout"}}).when("/about",{pageId:"about",templateUrl:e("About")}).when("/:year/:month/select-route/:origin/:destination",{pageId:"routes",templateUrl:e("SelectRoute"),controller:"SelectRouteController",resolve:{Layout:"Layout"}}).when("/:year/:month/routes/:routeId",{pageId:"route",templateUrl:e("RouteDetails"),controller:"RouteDetailsController",resolve:{Layout:"Layout"},reloadOnSearch:!1}).otherwise({redirectTo:"/"})}])}(),angular.module("RouteExplorer").controller("AppController",["$scope","$location",function(t,n){t.share=function(t){var e=t+encodeURIComponent("http://otrain.org/#"+n.url());window.open(e,"sharePopup","width=600,height=550,top=100,left=100,location=no,scrollbar=no,status=no,menubar=no")},t.$on("$routeChangeSuccess",function(n,e){t.bodyClass=e.pageId?"rex-page-"+e.pageId:null})}]),angular.module("RouteExplorer").controller("RouteDetailsController",["$scope","$route","$http","$location","LocationBinder","Layout","Locale",function(t,n,e,o,r,a,u){function i(t,n){return t=t||"all",n=n||"all",m[t]&&m[t][n]?m[t][n]:null}function l(){var n=i(t.selectedDay,t.selectedTime);return n?n.stops:[]}function s(n){function e(t){return("0"+t%24).slice(-2)+":00"}t.times=[];var o={};for(var r in n){var a=n[r],u="all"==a.info.hours?"all":a.info.hours[0]+"-"+a.info.hours[1],i=a.info.week_day;if(m[i]||(m[i]={}),m[i][u]=a,"all"!=u&&!o[u]){var l={id:u,from:e(a.info.hours[0]),to:e(a.info.hours[1])};o[u]=l,t.times.push(l)}}}var c=n.current.params.year,p=n.current.params.month,f=n.current.params.routeId,d=a.findRoute(f).stops,m={};t.loaded=!1,t.stopIds=d,t.origin=d[0],t.destination=d[d.length-1],t.selectedMonth=u.months[p-1].name+" "+c,t.selectedDay=null,t.days=u.days,t.selectedTime=null,t.times=[];var h=new Date(c,p-1,1),g=new Date(c,p,1);e.get("/api/route-info-full",{params:{route_id:f,from_date:h.getTime(),to_date:g.getTime()}}).success(function(n){s(n),t.loaded=!0}),r.bind(t,"selectedDay","day",function(t){return t?Number(t):null}),r.bind(t,"selectedTime","time"),t.stopStats=function(t){var n=l();for(var e in n)if(n[e].stop_id==t)return n[e];return null},t.stopName=function(t){var n=a.findStop(t);return n?n.name:null},t.isDayEmpty=function(t){var n=t.id,e=m[n];if(!e)return!0;for(var o in e)if(e[o].info.num_trips>0)return!1;return!0},t.isTimeEmpty=function(n){var e=t.selectedDay||"all",o=n.id,r=m[e]&&m[e][o];return r&&r.info.num_trips>0?!1:!0},t.tripCount=function(t,n){var e=i(t,n);return e?e.info.num_trips:0}}]),angular.module("RouteExplorer").controller("SelectRouteController",["$scope","$location","$route","Layout",function(t,n,e,o){function r(t){var n=o.findStop(t);return n?n.name:null}function a(t){function n(t){var n={};for(var e in t){var o=t[e];for(var r in o.stops){var a=o.stops[r];n[a]||(n[a]=0),n[a]++}}return n}function e(t,n){var e={};for(var o in t)t[o]==n&&(e[o]=!0);return e}function o(t,n){var e,o=[];for(var r in t){var a=t[r];r>0&&r<t.length-1&&n[a]?(e||(e=[],o.push(e)),e.push(a)):(e=null,o.push(a))}return o}var r=e(n(t),t.length);delete r[l.id],delete r[s.id];for(var a in t)t[a].stops=o(t[a].stops,r)}t.stops=o.getStops();var u=e.current.params.year,i=e.current.params.month,l=o.findStop(e.current.params.origin),s=o.findStop(e.current.params.destination);o.findRoutesByDate(l.id,s.id,u,i).then(function(n){n.length>1&&a(n),t.routes=n}),t.isCollapsed=function(t){return angular.isArray(t)},t.isOrigin=function(t){return t==l.id},t.isDestination=function(t){return t==s.id},t.stopText=function(n){return t.isCollapsed(n)?"•".repeat(n.length):r(n)},t.stopTooltip=function(n){return t.isCollapsed(n)?n.map(r).join(", "):null},t.barWidth=function(n){var e=100*n.count/t.routes[0].count;return 1>e?"1px":e+"%"},t.routeUrl=function(t){return"/#/"+u+"/"+i+"/routes/"+t.id}}]),angular.module("RouteExplorer").controller("SelectStopsController",["$scope","$rootScope","$location","Layout","Locale",function(t,n,e,o,r){t.stops=o.getStops(),t.origin=null,t.destination=null,t.months=r.months;var a=new Date,u=new Date(a.getFullYear(),a.getMonth()-1,1);t.month=u.getMonth()+1,t.year=u.getFullYear(),t.minYear=2013,t.maxYear=t.year,t.formValid=function(){return!!t.origin&&!!t.destination&&t.origin!=t.destination},t.stopName=function(t){var n=o.findStop(t);return n?n.name:null},t.goToRoutes=function(){t.noRoutes=!1,t.loading=!0,o.findRoutesByDate(t.origin.id,t.destination.id,t.year,t.month).then(function(n){0===n.length?t.noRoutes=!0:1==n.length?e.path("/"+t.year+"/"+t.month+"/routes/"+n[0].id):e.path("/"+t.year+"/"+t.month+"/select-route/"+t.origin.id+"/"+t.destination.id)})["finally"](function(){t.loading=!1})},t.dismissError=function(){t.noRoutes=!1}}]),angular.module("RouteExplorer").directive("rexPercentBar",["env",function(t){return{restrict:"E",scope:{value:"=value",type:"=type"},templateUrl:t.baseDir+"/tpls/PercentBar.html"}}]),angular.module("RouteExplorer").filter("duration",function(){return function(t){var n=!1;t=Math.trunc(t),0>t&&(n=!0,t=-t);var e=Math.trunc(t/60);t-=60*e;var o=Math.trunc(e/60);e-=60*o,10>t&&(t="0"+t),10>e&&0!==o&&(e="0"+e);var r=e+":"+t;return 0!==o&&(r=o+":"+r),n&&(r="-"+r),r}}),angular.module("RouteExplorer").factory("Layout",["$http","$q",function(t,n){var e=[],o={},r=[],a={},u=n.all([t.get("/api/stops").then(function(t){e=t.data.map(function(t){return{id:t.stop_id,name:t.heb_stop_names[0],names:t.heb_stop_names}}),e.forEach(function(t){o[t.id]=t})}),t.get("/api/all-routes").then(function(t){r=t.data.map(function(t){return{id:t.id,stops:t.stop_ids,count:t.count}}),a=r.reduce(function(t,n){return t[n.id]=n,t},{})})]),i=function(t){return o[t]||null},l=function(t,n,e){var o={};return t.forEach(function(t){var r=t.stops.indexOf(n),a=t.stops.indexOf(e);if(!(0>r||0>a||r>a)){var u=t.stops,i=t.id;i in o?o[i].count+=t.count:o[i]={id:i,stops:u,count:t.count}}}),o=Object.keys(o).map(function(t){return o[t]}),o.sort(function(t,n){return n.count-t.count}),o},s=function(e,o,a,u){var i=n.defer(),s=l(r,e,o);if(0===s.length)i.resolve([]);else{var c=new Date(a,u-1,1),p=new Date(a,u,1);t.get("/api/all-routes-by-date",{params:{from_date:c.getTime(),to_date:p.getTime()}}).then(function(t){var n=t.data.map(function(t){return{id:t.id,stops:t.stop_ids,count:t.count}});i.resolve(l(n,e,o))},function(t){i.reject({msg:"Error fetching routes",response:t})})}return i.promise},c=function(t){return a[t]||null};return service={getStops:function(){return e},getRoutes:function(){return r},findRoute:c,findStop:i,findRoutes:function(t,n){return l(r,t,n)},findRoutesByDate:s},u.then(function(){return service})}]),angular.module("RouteExplorer").constant("Locale",{months:["ינואר","פברואר","מרץ","אפריל","מאי","יוני","יולי","אוגוסט","ספטמבר","אוקטובר","נובמבר","דצמבר"].map(function(t,n){return{id:n+1,name:t}}),days:[{abbr:"א",name:"ראשון",id:1},{abbr:"ב",name:"שני",id:2},{abbr:"ג",name:"שלישי",id:3},{abbr:"ד",name:"רביעי",id:4},{abbr:"ה",name:"חמישי",id:5},{abbr:"ו",name:"שישי",id:6},{abbr:"ש",name:"שבת",id:7}]}),angular.module("RouteExplorer").factory("LocationBinder",["$location",function(t){return{bind:function(n,e,o,r,a){n[e]=t.search()[o]||null,n.$watch(e,function(n){a&&(n=a(n)),t.search(o,n)}),n.$watch(function(){return t.search()[o]||null},function(t){r&&(t=r(t)),n[e]=t})}}}]);
//# sourceMappingURL=app.js.map